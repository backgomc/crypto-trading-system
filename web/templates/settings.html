<!-- íŒŒì¼ ê²½ë¡œ: web/templates/settings.html -->
<!-- ì½”ë“œëª…: ì„¤ì • í˜ì´ì§€ í…œí”Œë¦¿ (routes.pyì™€ ì™„ì „ ë™ê¸°í™”) -->

{% extends "base.html" %}

{% block title %}NHBot - ì„¤ì •{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="bi bi-gear me-2"></i>ì„¤ì •
        </h2>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="resetSettings()" id="resetBtn">
                <i class="bi bi-arrow-clockwise me-1"></i>ê¸°ë³¸ê°’ ë³µì›
            </button>
            <button class="btn btn-primary" onclick="saveSettings()" id="saveBtn">
                <i class="bi bi-check-lg me-1"></i>ì„¤ì • ì €ì¥
            </button>
        </div>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loadingOverlay" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50" style="z-index: 9999;">
        <div class="position-absolute top-50 start-50 translate-middle text-center">
            <div class="spinner-border text-primary mb-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="text-white">ì„¤ì • ì²˜ë¦¬ ì¤‘...</div>
        </div>
    </div>

    <!-- ì•Œë¦¼ ë©”ì‹œì§€ -->
    <div id="alertContainer"></div>

    <div class="row">
        <!-- ì¢Œì¸¡: ì„¤ì • í¼ë“¤ -->
        <div class="col-lg-8">
            <!-- ê¸°ë³¸ ë§¤ë§¤ ì„¤ì • -->
            <div class="card bg-dark border-secondary shadow-sm mb-4">
                <div class="card-header bg-secondary">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>ê¸°ë³¸ ë§¤ë§¤ ì„¤ì •
                    </h5>
                </div>
                <div class="card-body">
                    <form id="tradingForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">ë§¤ë§¤ ëª¨ë“œ</label>
                                <select class="form-select" id="demo_mode">
                                    <option value="true">ğŸ“Š ë°ëª¨ ë§¤ë§¤</option>
                                    <option value="false">ğŸ’° ì‹¤ì œ ë§¤ë§¤</option>
                                </select>
                                <div class="form-text">ë°ëª¨ ëª¨ë“œì—ì„œëŠ” ê°€ìƒ ìê¸ˆìœ¼ë¡œ ë§¤ë§¤ê°€ ì§„í–‰ë©ë‹ˆë‹¤</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">ê°€ìƒ ì”ê³  (USDT)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="virtual_balance" min="1000" max="1000000">
                                    <span class="input-group-text">USDT</span>
                                </div>
                                <div class="form-text">ë°ëª¨ ëª¨ë“œì—ì„œ ì‚¬ìš©í•  ê°€ìƒ ìê¸ˆ</div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">ì´ˆê¸° í¬ì§€ì…˜ í¬ê¸°</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="initial_position_size" step="0.001" min="0.001" max="1">
                                    <span class="input-group-text">BTC</span>
                                </div>
                                <div class="form-text">ì²« ë§¤ë§¤ ì‹œ ì§„ì…í•  í¬ì§€ì…˜ í¬ê¸°</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">ì¡°ì • í¬ê¸°</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="adjustment_size" step="0.001" min="0.001" max="0.1">
                                    <span class="input-group-text">BTC</span>
                                </div>
                                <div class="form-text">ì¶”ê°€ ë§¤ë§¤ ì‹œ ì¡°ì •í•  í¬ì§€ì…˜ í¬ê¸°</div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">ê¸°ë³¸ ì„ê³„ê°’</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="base_threshold" min="100" max="10000">
                                    <span class="input-group-text">USDT</span>
                                </div>
                                <div class="form-text">ë§¤ë§¤ ì‹ í˜¸ë¥¼ ë°œìƒì‹œí‚¬ ê°€ê²© ë³€ë™ ê¸°ì¤€</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">ì—°ì† ì‹ í˜¸ ê¸°ì¤€</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="consecutive_threshold" min="2" max="10">
                                    <span class="input-group-text">íšŒ</span>
                                </div>
                                <div class="form-text">ì—°ì† ì‹ í˜¸ í›„ ëŒ€ì‘ ë§¤ë§¤ë¥¼ ì‹¤í–‰í•  ê¸°ì¤€</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="adaptive_threshold_enabled">
                                    <label class="form-check-label fw-medium" for="adaptive_threshold_enabled">
                                        ì ì‘í˜• ì„ê³„ê°’ ì‚¬ìš©
                                    </label>
                                </div>
                                <div class="form-text">ì‹œì¥ ë³€ë™ì„±ì— ë”°ë¥¸ ì„ê³„ê°’ ìë™ ì¡°ì •</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">ë³€ë™ì„± ìœˆë„ìš°</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="volatility_window" min="5" max="100">
                                    <span class="input-group-text">ì¼</span>
                                </div>
                                <div class="form-text">ë³€ë™ì„± ê³„ì‚°ì— ì‚¬ìš©í•  ê¸°ê°„</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">ë£¨í”„ ê°„ê²©</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="loop_delay" min="10" max="300">
                                    <span class="input-group-text">ì´ˆ</span>
                                </div>
                                <div class="form-text">ë§¤ë§¤ ë¡œì§ ì‹¤í–‰ ê°„ê²©</div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- AI ì„¤ì • -->
            <div class="card bg-dark border-secondary shadow-sm mb-4">
                <div class="card-header bg-secondary">
                    <h5 class="mb-0">
                        <i class="bi bi-brain me-2"></i>AI ì„¤ì •
                    </h5>
                </div>
                <div class="card-body">
                    <form id="aiForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="ai_enabled">
                                    <label class="form-check-label fw-medium" for="ai_enabled">
                                        AI ëª¨ë¸ ì‚¬ìš©
                                    </label>
                                </div>
                                <div class="form-text">AI ì˜ˆì¸¡ì„ ë§¤ë§¤ ê²°ì •ì— ë°˜ì˜</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">ë©”ì¸ ì‹œê°„ëŒ€</label>
                                <select class="form-select" id="main_interval">
                                    <option value="1">1ë¶„ë´‰</option>
                                    <option value="5">5ë¶„ë´‰</option>
                                    <option value="15">15ë¶„ë´‰</option>
                                    <option value="60">1ì‹œê°„ë´‰</option>
                                </select>
                                <div class="form-text">ì£¼ìš” ë§¤ë§¤ íŒë‹¨ ê¸°ì¤€ ì‹œê°„ëŒ€</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">AI í•™ìŠµ ê¸°ê°„</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="training_days" min="30" max="1095">
                                    <span class="input-group-text">ì¼</span>
                                </div>
                                <div class="form-text">AI í•™ìŠµì— ì‚¬ìš©í•  ê³¼ê±° ë°ì´í„° ê¸°ê°„</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">ëª¨ë¸ ì¬í›ˆë ¨ ê°„ê²©</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="retrain_interval_days" min="1" max="30">
                                    <span class="input-group-text">ì¼</span>
                                </div>
                                <div class="form-text">ìë™ ì¬í›ˆë ¨ ì‹¤í–‰ ê°„ê²©</div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì„¤ì • -->
            <div class="card bg-dark border-secondary shadow-sm mb-4">
                <div class="card-header bg-secondary">
                    <h5 class="mb-0">
                        <i class="bi bi-shield-check me-2"></i>ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì„¤ì •
                    </h5>
                </div>
                <div class="card-body">
                    <form id="riskForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">ìµœëŒ€ ì†ì‹¤ í•œë„</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="max_loss_percent" min="1" max="20" step="0.1">
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="form-text">ì „ì²´ ì”ê³  ëŒ€ë¹„ ìµœëŒ€ ì†ì‹¤ í—ˆìš© ë¹„ìœ¨</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">ì¼ì¼ ê±°ë˜ í•œë„</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="daily_trade_limit" min="1" max="100">
                                    <span class="input-group-text">íšŒ</span>
                                </div>
                                <div class="form-text">í•˜ë£¨ ìµœëŒ€ ê±°ë˜ ì‹¤í–‰ íšŸìˆ˜</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">í¬ì§€ì…˜ í¬ê¸° ìƒí•œ</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="max_position_size" step="0.01" min="0.01" max="2">
                                    <span class="input-group-text">BTC</span>
                                </div>
                                <div class="form-text">ë‹¨ì¼ í¬ì§€ì…˜ì˜ ìµœëŒ€ í¬ê¸°</div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" id="emergency_stop_enabled">
                                    <label class="form-check-label fw-medium" for="emergency_stop_enabled">
                                        ê¸´ê¸‰ ì •ì§€ í™œì„±í™”
                                    </label>
                                </div>
                                <div class="form-text">ë¹„ì •ìƒ ìƒí™© ì‹œ ìë™ ê±°ë˜ ì¤‘ì§€</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">ì—°ì† ì†ì‹¤ ì œí•œ</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="consecutive_loss_limit" min="2" max="10">
                                    <span class="input-group-text">íšŒ</span>
                                </div>
                                <div class="form-text">ì—°ì† ì†ì‹¤ ì‹œ ê±°ë˜ ì¼ì‹œ ì¤‘ì§€</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">ì¿¨ë‹¤ìš´ ì‹œê°„</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="cooldown_minutes" min="5" max="120">
                                    <span class="input-group-text">ë¶„</span>
                                </div>
                                <div class="form-text">ì—°ì† ì†ì‹¤ í›„ ê±°ë˜ ì¬ê°œê¹Œì§€ ëŒ€ê¸° ì‹œê°„</div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ì•Œë¦¼ ì„¤ì • -->
            <div class="card notification-card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-bell me-2"></i>ì•Œë¦¼ ì„¤ì •
                    </h5>
                </div>
                <div class="card-body">
                    <form id="notificationForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="telegram_enabled">
                                    <label class="form-check-label fw-medium" for="telegram_enabled">
                                        í…”ë ˆê·¸ë¨ ì•Œë¦¼
                                    </label>
                                </div>
                                <div class="form-text">ë§¤ë§¤ ë° ì‹œìŠ¤í…œ ìƒíƒœ ì•Œë¦¼</div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="email_enabled">
                                    <label class="form-check-label fw-medium" for="email_enabled">
                                        ì´ë©”ì¼ ì•Œë¦¼
                                    </label>
                                </div>
                                <div class="form-text">ì¤‘ìš” ì´ë²¤íŠ¸ ì´ë©”ì¼ ì•Œë¦¼</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">ì•Œë¦¼ ë¹ˆë„</label>
                                <select class="form-select" id="frequency">
                                    <option value="all">ëª¨ë“  ê±°ë˜</option>
                                    <option value="important">ì¤‘ìš” ì´ë²¤íŠ¸ë§Œ</option>
                                    <option value="summary">ì¼ì¼ ìš”ì•½</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">ìˆ˜ìµ ì•Œë¦¼ ê¸°ì¤€</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="profit_threshold_krw" min="100">
                                    <span class="input-group-text">ì›</span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ìš°ì¸¡: ìƒíƒœ ë° ì •ë³´ -->
        <div class="col-lg-4">
            <!-- í˜„ì¬ ìƒíƒœ -->
            <div class="card bg-dark border-secondary shadow-sm mb-4">
                <div class="card-header bg-secondary">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>í˜„ì¬ ìƒíƒœ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>ì„¤ì • ìƒíƒœ</span>
                        <span class="badge bg-secondary" id="configStatus">ë¡œë”© ì¤‘</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>ë§ˆì§€ë§‰ ì €ì¥</span>
                        <span class="text-muted" id="lastSaved">-</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>ì„¤ì • íŒŒì¼</span>
                        <span class="text-success">
                            <i class="bi bi-check-circle"></i>
                        </span>
                    </div>
                    
                    <hr>
                    
                    <h6 class="mb-3">ë¹ ë¥¸ ì„¤ì •</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="applyPreset('conservative')">
                            <i class="bi bi-shield me-1"></i>ë³´ìˆ˜ì  ì„¤ì •
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="applyPreset('balanced')">
                            <i class="bi bi-bar-chart me-1"></i>ê· í˜• ì„¤ì •
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="applyPreset('aggressive')">
                            <i class="bi bi-lightning me-1"></i>ê³µê²©ì  ì„¤ì •
                        </button>
                    </div>
                </div>
            </div>

            <!-- ì„¤ì • ë„ì›€ë§ -->
            <div class="card help-card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-question-circle me-2"></i>ì„¤ì • ë„ì›€ë§
                    </h5>
                </div>
                <div class="card-body">
                    <div class="accordion accordion-flush" id="helpAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help1">
                                    ë§¤ë§¤ ëª¨ë“œ
                                </button>
                            </h2>
                            <div id="help1" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <small>ë°ëª¨ ëª¨ë“œëŠ” ì‹¤ì œ ìê¸ˆ ì—†ì´ ê°€ìƒìœ¼ë¡œ ë§¤ë§¤ë¥¼ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‹¤ì œ ë§¤ë§¤ ì „ì— ì¶©ë¶„í•œ í…ŒìŠ¤íŠ¸ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help2">
                                    ë¦¬ìŠ¤í¬ ê´€ë¦¬
                                </button>
                            </h2>
                            <div id="help2" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <small>ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì„¤ì •ì€ ì†ì‹¤ì„ ì œí•œí•˜ê³  ì•ˆì „í•œ ê±°ë˜ë¥¼ ìœ„í•´ ì¤‘ìš”í•©ë‹ˆë‹¤. ë³´ìˆ˜ì ì¸ ì„¤ì •ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.</small>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help3">
                                    AI ëª¨ë¸
                                </button>
                            </h2>
                            <div id="help3" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <small>AI ëª¨ë¸ì€ ì›ì›¨ì´ ì¥ì—ì„œì˜ ì†ì‹¤ì„ ìµœì†Œí™”í•˜ê¸° ìœ„í•´ ë§¤ë§¤ íƒ€ì´ë°ì„ ì •êµí•˜ê²Œ íŒë‹¨í•©ë‹ˆë‹¤. 15ë¶„ë´‰ ê¸°ì¤€ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ì „ì—­ ë³€ìˆ˜
    let currentConfig = {};
    let isLoading = false;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', function() {
        loadConfig();
        initEventListeners();
    });

    // ============================================================================
    // API í˜¸ì¶œ ë° ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    // ============================================================================

    async function apiCall(url, method = 'GET', data = null) {
        showLoading(true);
        try {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }

            const response = await fetch(url, options);
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || `HTTP ${response.status}: ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
            }

            return result;
        } catch (error) {
            console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error);
            showAlert('error', error.message || 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            throw error;
        } finally {
            showLoading(false);
        }
    }

    function showLoading(show) {
        isLoading = show;
        const overlay = document.getElementById('loadingOverlay');
        const saveBtn = document.getElementById('saveBtn');
        const resetBtn = document.getElementById('resetBtn');
        
        if (show) {
            overlay.classList.remove('d-none');
            saveBtn.disabled = true;
            resetBtn.disabled = true;
        } else {
            overlay.classList.add('d-none');
            saveBtn.disabled = false;
            resetBtn.disabled = false;
        }
    }

    function showAlert(type, message) {
        const container = document.getElementById('alertContainer');
        const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
        const iconClass = type === 'error' ? 'bi-exclamation-triangle' : 'bi-check-circle';
        
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                <i class="bi ${iconClass} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        container.innerHTML = alertHtml;
        
        setTimeout(() => {
            const alert = container.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 3000);
    }

    // ë¸Œë¼ìš°ì € ì•Œë¦¼ í•¨ìˆ˜ ì¶”ê°€
    function showBrowserNotification(title, message) {
        // ì•Œë¦¼ ê¶Œí•œ ì²´í¬
        if (Notification.permission === 'granted') {
            new Notification(`NHBot - ${title}`, {
                body: message,
                icon: '/static/images/nhbot-icon.png',
                badge: '/static/images/nhbot-icon.png'
            });
        } else if (Notification.permission !== 'denied') {
            // ê¶Œí•œ ìš”ì²­
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    new Notification(`NHBot - ${title}`, {
                        body: message,
                        icon: '/static/images/nhbot-icon.png',
                        badge: '/static/images/nhbot-icon.png'
                    });
                } else {
                    // ê¶Œí•œì´ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ fallback
                    showAlert(title === 'ì„±ê³µ' ? 'success' : 'error', message);
                }
            });
        } else {
            // ê¶Œí•œì´ ê±°ë¶€ëœ ê²½ìš° ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ fallback
            showAlert(title === 'ì„±ê³µ' ? 'success' : 'error', message);
        }
    }

    // ============================================================================
    // ì„¤ì • ë¡œë“œ ë° ì €ì¥ í•¨ìˆ˜ë“¤
    // ============================================================================

    async function loadConfig() {
        try {
            console.log('ğŸ”„ ì„¤ì • ë¡œë“œ ì‹œì‘...');
            const result = await apiCall('/api/config');
            
            if (result.success && result.data && result.data.config) {
                currentConfig = result.data.config;
                console.log('âœ… ì„¤ì • ë¡œë“œ ì„±ê³µ:', currentConfig);
                
                // í¼ì— ì„¤ì •ê°’ ì ìš©
                populateForm(currentConfig);
                updateStatusDisplay();
                showAlert('success', 'ì„¤ì •ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
            } else {
                throw new Error('ì„¤ì • ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
            
        } catch (error) {
            console.error('âŒ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
            showAlert('error', 'ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }

    function populateForm(config) {
        console.log('ğŸ“ í¼ ë°ì´í„° ì ìš© ì‹œì‘:', config);
        
        // ë§¤ë§¤ ì„¤ì • (trading)
        if (config.trading) {
            const t = config.trading;
            setElementValue('demo_mode', String(t.demo_mode !== false));
            setElementValue('virtual_balance', t.virtual_balance || 10000);
            setElementValue('initial_position_size', t.initial_position_size || 0.05);
            setElementValue('adjustment_size', t.adjustment_size || 0.01);
            setElementValue('base_threshold', t.base_threshold || 1000);
            setElementValue('consecutive_threshold', t.consecutive_threshold || 4);
            setElementValue('adaptive_threshold_enabled', t.adaptive_threshold_enabled !== false);
            setElementValue('volatility_window', t.volatility_window || 20);
            setElementValue('loop_delay', t.loop_delay || 60);
        }

        // AI ì„¤ì • (ai)
        if (config.ai) {
            const a = config.ai;
            setElementValue('ai_enabled', a.enabled !== false);
            setElementValue('main_interval', a.main_interval || '15');
            setElementValue('training_days', a.training_days || 365);
            setElementValue('retrain_interval_days', a.retrain_interval_days || 14);
        }

        // ë¦¬ìŠ¤í¬ ì„¤ì • (risk)
        if (config.risk) {
            const r = config.risk;
            setElementValue('max_loss_percent', r.max_loss_percent || 5.0);
            setElementValue('daily_trade_limit', r.daily_trade_limit || 10);
            setElementValue('max_position_size', r.max_position_size || 0.5);
            setElementValue('emergency_stop_enabled', r.emergency_stop_enabled !== false);
            setElementValue('consecutive_loss_limit', r.consecutive_loss_limit || 3);
            setElementValue('cooldown_minutes', r.cooldown_minutes || 30);
        }

        // ì•Œë¦¼ ì„¤ì • (notifications)
        if (config.notifications) {
            const n = config.notifications;
            setElementValue('telegram_enabled', n.telegram_enabled !== false);
            setElementValue('email_enabled', n.email_enabled || false);
            setElementValue('frequency', n.frequency || 'all');
            setElementValue('profit_threshold_krw', n.profit_threshold_krw || 1000);
        }
        
        console.log('âœ… í¼ ë°ì´í„° ì ìš© ì™„ë£Œ');
    }

    function setElementValue(id, value) {
        const element = document.getElementById(id);
        if (!element) {
            console.warn(`âš ï¸ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${id}`);
            return;
        }

        if (element.type === 'checkbox') {
            element.checked = Boolean(value);
        } else if (element.type === 'select-one') {
            element.value = String(value);
        } else {
            element.value = value;
        }
    }

    function collectFormData() {
        const formData = {
            config: {
                trading: {
                    demo_mode: document.getElementById('demo_mode').value === 'true',
                    virtual_balance: parseFloat(document.getElementById('virtual_balance').value),
                    symbol: "BTCUSDT",
                    initial_position_size: parseFloat(document.getElementById('initial_position_size').value),
                    adjustment_size: parseFloat(document.getElementById('adjustment_size').value),
                    base_threshold: parseInt(document.getElementById('base_threshold').value),
                    consecutive_threshold: parseInt(document.getElementById('consecutive_threshold').value),
                    adaptive_threshold_enabled: document.getElementById('adaptive_threshold_enabled').checked,
                    volatility_window: parseInt(document.getElementById('volatility_window').value),
                    loop_delay: parseInt(document.getElementById('loop_delay').value)
                },
                ai: {
                    enabled: document.getElementById('ai_enabled').checked,
                    main_interval: document.getElementById('main_interval').value,
                    training_days: parseInt(document.getElementById('training_days').value),
                    retrain_interval_days: parseInt(document.getElementById('retrain_interval_days').value),
                    timeframes: ["1", "5", "15", "60"]
                },
                risk: {
                    max_loss_percent: parseFloat(document.getElementById('max_loss_percent').value),
                    daily_trade_limit: parseInt(document.getElementById('daily_trade_limit').value),
                    max_position_size: parseFloat(document.getElementById('max_position_size').value),
                    emergency_stop_enabled: document.getElementById('emergency_stop_enabled').checked,
                    consecutive_loss_limit: parseInt(document.getElementById('consecutive_loss_limit').value),
                    cooldown_minutes: parseInt(document.getElementById('cooldown_minutes').value)
                },
                notifications: {
                    telegram_enabled: document.getElementById('telegram_enabled').checked,
                    email_enabled: document.getElementById('email_enabled').checked,
                    frequency: document.getElementById('frequency').value,
                    profit_threshold_krw: parseInt(document.getElementById('profit_threshold_krw').value)
                }
            }
        };
        
        console.log('ğŸ“Š ìˆ˜ì§‘ëœ í¼ ë°ì´í„°:', formData);
        return formData;
    }

    // ============================================================================
    // ì„¤ì • ì €ì¥ ë° ë¦¬ì…‹ í•¨ìˆ˜ë“¤
    // ============================================================================

    async function saveSettings() {
        if (isLoading) return;

        try {
            if (!validateForm()) {
                return;
            }

            console.log('ğŸ’¾ ì„¤ì • ì €ì¥ ì‹œì‘...');
            const formData = collectFormData();
            
            const result = await apiCall('/api/config', 'PUT', formData);
            
            if (result.success) {
                currentConfig = result.data.config;
                updateStatusDisplay();
                
                // ë¸Œë¼ìš°ì € ì•Œë¦¼ìœ¼ë¡œ ë³€ê²½
                showBrowserNotification('ì„±ê³µ', 'ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                console.log('âœ… ì„¤ì • ì €ì¥ ì™„ë£Œ');
            } else {
                throw new Error(result.error || 'ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            
        } catch (error) {
            console.error('âŒ ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', error);
            showBrowserNotification('ì˜¤ë¥˜', 'ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + error.message);
        }
    }

    async function resetSettings() {
        if (isLoading) return;

        if (!confirm('ëª¨ë“  ì„¤ì •ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ì„¤ì •ì€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) {
            return;
        }

        try {
            console.log('ğŸ”„ ì„¤ì • ì´ˆê¸°í™” ì‹œì‘...');
            const result = await apiCall('/api/config/reset', 'POST');
            
            if (result.success) {
                currentConfig = result.data.config;
                populateForm(currentConfig);
                updateStatusDisplay();
                showAlert('success', result.message || 'ëª¨ë“  ì„¤ì •ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
                console.log('âœ… ì„¤ì • ì´ˆê¸°í™” ì™„ë£Œ');
            } else {
                throw new Error(result.error || 'ì„¤ì • ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            
        } catch (error) {
            console.error('âŒ ì„¤ì • ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            showAlert('error', 'ì„¤ì • ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message);
        }
    }

    async function applyPreset(presetType) {
        if (isLoading) return;

        const presetNames = {
            conservative: 'ë³´ìˆ˜ì ',
            balanced: 'ê· í˜•',
            aggressive: 'ê³µê²©ì '
        };

        if (!confirm(`${presetNames[presetType]} ì„¤ì •ì„ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ì„¤ì •ì´ ë³€ê²½ë©ë‹ˆë‹¤.`)) {
            return;
        }

        try {
            console.log(`ğŸ¯ ${presetType} í”„ë¦¬ì…‹ ì ìš© ì‹œì‘...`);
            const result = await apiCall(`/api/config/preset/${presetType}`, 'POST');
            
            if (result.success) {
                currentConfig = result.data.config;
                populateForm(currentConfig);
                updateStatusDisplay();
                showAlert('success', result.message || `${presetNames[presetType]} ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                console.log(`âœ… ${presetType} í”„ë¦¬ì…‹ ì ìš© ì™„ë£Œ`);
            } else {
                throw new Error(result.error || 'í”„ë¦¬ì…‹ ì ìš©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            
        } catch (error) {
            console.error(`âŒ ${presetType} í”„ë¦¬ì…‹ ì ìš© ì‹¤íŒ¨:`, error);
            showAlert('error', 'í”„ë¦¬ì…‹ ì ìš© ì‹¤íŒ¨: ' + error.message);
        }
    }

    // ============================================================================
    // ìœ íš¨ì„± ê²€ì‚¬ ë° ìƒíƒœ ê´€ë¦¬
    // ============================================================================

    function validateForm() {
        const errors = [];

        // í•„ìˆ˜ í•„ë“œ ê²€ì‚¬
        const requiredFields = [
            'virtual_balance', 'initial_position_size', 'adjustment_size',
            'base_threshold', 'consecutive_threshold', 'volatility_window', 'loop_delay',
            'training_days', 'retrain_interval_days',
            'max_loss_percent', 'daily_trade_limit', 'max_position_size',
            'consecutive_loss_limit', 'cooldown_minutes', 'profit_threshold_krw'
        ];

        for (const fieldId of requiredFields) {
            const element = document.getElementById(fieldId);
            if (!element || !element.value || isNaN(parseFloat(element.value))) {
                const label = element ? element.closest('.col-md-6, .col-md-12')?.querySelector('label')?.textContent || fieldId : fieldId;
                errors.push(`${label}ì€(ëŠ”) í•„ìˆ˜ ì…ë ¥ê°’ì…ë‹ˆë‹¤.`);
            }
        }

        // ë²”ìœ„ ê²€ì‚¬
        const rangeChecks = [
            { id: 'virtual_balance', min: 1000, max: 1000000, name: 'ê°€ìƒ ì”ê³ ' },
            { id: 'initial_position_size', min: 0.001, max: 1, name: 'ì´ˆê¸° í¬ì§€ì…˜ í¬ê¸°' },
            { id: 'adjustment_size', min: 0.001, max: 0.1, name: 'ì¡°ì • í¬ê¸°' },
            { id: 'base_threshold', min: 100, max: 10000, name: 'ê¸°ë³¸ ì„ê³„ê°’' },
            { id: 'consecutive_threshold', min: 2, max: 10, name: 'ì—°ì† ì‹ í˜¸ ê¸°ì¤€' },
            { id: 'volatility_window', min: 5, max: 100, name: 'ë³€ë™ì„± ìœˆë„ìš°' },
            { id: 'loop_delay', min: 10, max: 300, name: 'ë£¨í”„ ê°„ê²©' },
            { id: 'training_days', min: 30, max: 1095, name: 'AI í•™ìŠµ ê¸°ê°„' },
            { id: 'retrain_interval_days', min: 1, max: 30, name: 'ëª¨ë¸ ì¬í›ˆë ¨ ê°„ê²©' },
            { id: 'max_loss_percent', min: 1.0, max: 20.0, name: 'ìµœëŒ€ ì†ì‹¤ í•œë„' },
            { id: 'daily_trade_limit', min: 1, max: 100, name: 'ì¼ì¼ ê±°ë˜ í•œë„' },
            { id: 'max_position_size', min: 0.01, max: 2.0, name: 'í¬ì§€ì…˜ í¬ê¸° ìƒí•œ' },
            { id: 'consecutive_loss_limit', min: 2, max: 10, name: 'ì—°ì† ì†ì‹¤ ì œí•œ' },
            { id: 'cooldown_minutes', min: 5, max: 120, name: 'ì¿¨ë‹¤ìš´ ì‹œê°„' },
            { id: 'profit_threshold_krw', min: 100, max: 100000, name: 'ìˆ˜ìµ ì•Œë¦¼ ê¸°ì¤€' }
        ];

        for (const check of rangeChecks) {
            const element = document.getElementById(check.id);
            if (element && element.value) {
                const value = parseFloat(element.value);
                if (value < check.min || value > check.max) {
                    errors.push(`${check.name}ì€(ëŠ”) ${check.min}~${check.max} ë²”ìœ„ ë‚´ì—ì„œ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
                }
            }
        }

        if (errors.length > 0) {
            showAlert('error', errors.join('<br>'));
            return false;
        }

        return true;
    }

    function updateStatusDisplay() {
        const configStatus = document.getElementById('configStatus');
        const lastSaved = document.getElementById('lastSaved');
        
        configStatus.textContent = 'ì €ì¥ë¨';
        configStatus.className = 'badge bg-success';
        
        const now = new Date();
        lastSaved.textContent = now.toLocaleString('ko-KR', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function markAsChanged() {
        const configStatus = document.getElementById('configStatus');
        configStatus.textContent = 'ë³€ê²½ë¨';
        configStatus.className = 'badge bg-warning';
    }

    // ============================================================================
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
    // ============================================================================

    function initEventListeners() {
        // ì‹¤ì‹œê°„ ìœ íš¨ì„± ê²€ì‚¬
        const numberInputs = document.querySelectorAll('input[type="number"]');
        numberInputs.forEach(input => {
            input.addEventListener('blur', function() {
                validateField(this);
            });
        });

        // ì„¤ì • ë³€ê²½ ê°ì§€
        const formElements = document.querySelectorAll('input, select');
        formElements.forEach(element => {
            element.addEventListener('change', markAsChanged);
        });

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (Ctrl+Së¡œ ì €ì¥)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveSettings();
            }
        });

        // í˜ì´ì§€ ì´íƒˆ ì‹œ ê²½ê³ 
        window.addEventListener('beforeunload', function(e) {
            const configStatus = document.getElementById('configStatus');
            if (configStatus.textContent === 'ë³€ê²½ë¨') {
                e.preventDefault();
                e.returnValue = 'ì €ì¥í•˜ì§€ ì•Šì€ ì„¤ì • ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë– ë‚˜ì‹œê² ìŠµë‹ˆê¹Œ?';
            }
        });
    }

    function validateField(input) {
        const min = parseFloat(input.min);
        const max = parseFloat(input.max);
        const value = parseFloat(input.value);
        
        if (input.value && (value < min || value > max)) {
            input.classList.add('is-invalid');
            
            // ê¸°ì¡´ ì—ëŸ¬ ë©”ì‹œì§€ ì œê±°
            const existingError = input.parentNode.querySelector('.invalid-feedback');
            if (existingError) {
                existingError.remove();
            }
            
            // ì—ëŸ¬ ë©”ì‹œì§€ ì¶”ê°€
            const errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback';
            errorDiv.textContent = `${min}~${max} ë²”ìœ„ ë‚´ì—ì„œ ì…ë ¥í•´ì£¼ì„¸ìš”.`;
            input.parentNode.appendChild(errorDiv);
        } else {
            input.classList.remove('is-invalid');
            const errorDiv = input.parentNode.querySelector('.invalid-feedback');
            if (errorDiv) {
                errorDiv.remove();
            }
        }
    }

    // ============================================================================
    // ì¶”ê°€ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    // ============================================================================

    function exportSettings() {
        try {
            const formData = collectFormData();
            const dataStr = JSON.stringify(formData.config, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `nhbot_settings_${new Date().toISOString().slice(0, 10)}.json`;
            link.click();
            
            showAlert('success', 'ì„¤ì •ì´ íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (error) {
            showAlert('error', 'ì„¤ì • ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    function importSettings() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settings = JSON.parse(e.target.result);
                    populateForm(settings);
                    markAsChanged();
                    showAlert('success', 'ì„¤ì •ì„ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.');
                } catch (error) {
                    showAlert('error', 'ì„¤ì • íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            };
            reader.readAsText(file);
        };
        
        input.click();
    }

    function showDebugInfo() {
        console.log('ğŸ” ë””ë²„ê·¸ ì •ë³´:');
        console.log('í˜„ì¬ ì„¤ì •:', currentConfig);
        console.log('í¼ ë°ì´í„°:', collectFormData());
        console.log('ë¡œë”© ìƒíƒœ:', isLoading);
    }

    // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (ê°œë°œìš©)
    window.debugSettings = showDebugInfo;
    window.exportSettings = exportSettings;
    window.importSettings = importSettings;

    // ì´ˆê¸°í™” ì™„ë£Œ ë¡œê·¸
    console.log('ğŸš€ NHBot ì„¤ì • í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
    console.log('ğŸ’¡ ì‚¬ìš© ê°€ëŠ¥í•œ ì½˜ì†” ëª…ë ¹ì–´:');
    console.log('   - debugSettings(): í˜„ì¬ ì„¤ì • ìƒíƒœ í™•ì¸');
    console.log('   - exportSettings(): ì„¤ì • ë‚´ë³´ë‚´ê¸°');
    console.log('   - importSettings(): ì„¤ì • ê°€ì ¸ì˜¤ê¸°');
</script>
{% endblock %}