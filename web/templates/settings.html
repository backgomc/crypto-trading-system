<!-- 파일 경로: web/templates/settings.html -->
<!-- 코드명: 설정 페이지 템플릿 (AI 항목 제거, 추가 설정 포함) -->

{% extends "base.html" %}

{% block title %}설정 - 자동매매{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 페이지 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="bi bi-gear me-2"></i>설정
        </h2>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="resetSettings()">
                <i class="bi bi-arrow-clockwise me-1"></i>기본값 복원
            </button>
            <button class="btn btn-primary" onclick="saveSettings()">
                <i class="bi bi-check-lg me-1"></i>설정 저장
            </button>
        </div>
    </div>

    <div class="row">
        <!-- 좌측: 설정 폼들 -->
        <div class="col-lg-8">
            <!-- 기본 매매 설정 -->
            <div class="card bg-dark border-secondary shadow-sm mb-4">
                <div class="card-header bg-secondary">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>기본 매매 설정
                    </h5>
                </div>
                <div class="card-body">
                    <form id="tradingForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">매매 모드</label>
                                <select class="form-select" id="tradingMode">
                                    <option value="demo" selected>📊 데모 매매</option>
                                    <option value="real">💰 실제 매매</option>
                                </select>
                                <div class="form-text">데모 모드에서는 가상 자금으로 매매가 진행됩니다</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">가상 잔고 (USDT)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="virtualBalance" value="10000" min="1000" max="1000000">
                                    <span class="input-group-text">USDT</span>
                                </div>
                                <div class="form-text">데모 모드에서 사용할 가상 자금</div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">초기 포지션 크기</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="initialPosition" value="0.05" step="0.001" min="0.001" max="1">
                                    <span class="input-group-text">BTC</span>
                                </div>
                                <div class="form-text">첫 매매 시 진입할 포지션 크기</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">조정 크기</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="adjustmentSize" value="0.01" step="0.001" min="0.001" max="0.1">
                                    <span class="input-group-text">BTC</span>
                                </div>
                                <div class="form-text">추가 매매 시 조정할 포지션 크기</div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">기본 임계값</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="baseThreshold" value="1000" min="100" max="10000">
                                    <span class="input-group-text">USDT</span>
                                </div>
                                <div class="form-text">매매 신호를 발생시킬 가격 변동 기준</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">연속 신호 기준</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="consecutiveThreshold" value="4" min="2" max="10">
                                    <span class="input-group-text">회</span>
                                </div>
                                <div class="form-text">연속 신호 후 대응 매매를 실행할 기준</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="adaptiveThreshold" checked>
                                    <label class="form-check-label fw-medium" for="adaptiveThreshold">
                                        적응형 임계값 사용
                                    </label>
                                </div>
                                <div class="form-text">시장 변동성에 따른 임계값 자동 조정</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">변동성 윈도우</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="volatilityWindow" value="20" min="5" max="100">
                                    <span class="input-group-text">일</span>
                                </div>
                                <div class="form-text">변동성 계산에 사용할 기간</div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 리스크 관리 설정 -->
            <div class="card bg-dark border-secondary shadow-sm mb-4">
                <div class="card-header bg-secondary">
                    <h5 class="mb-0">
                        <i class="bi bi-shield-check me-2"></i>리스크 관리 설정
                    </h5>
                </div>
                <div class="card-body">
                    <form id="riskForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">최대 손실 한도</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="maxLossLimit" value="5" min="1" max="20" step="0.1">
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="form-text">전체 잔고 대비 최대 손실 허용 비율</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">일일 거래 한도</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="dailyTradeLimit" value="10" min="1" max="100">
                                    <span class="input-group-text">회</span>
                                </div>
                                <div class="form-text">하루 최대 거래 실행 횟수</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">포지션 크기 상한</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="maxPositionSize" value="0.5" step="0.01" min="0.01" max="2">
                                    <span class="input-group-text">BTC</span>
                                </div>
                                <div class="form-text">단일 포지션의 최대 크기</div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" id="emergencyStopEnabled" checked>
                                    <label class="form-check-label fw-medium" for="emergencyStopEnabled">
                                        긴급 정지 활성화
                                    </label>
                                </div>
                                <div class="form-text">비정상 상황 시 자동 거래 중지</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">연속 손실 제한</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="consecutiveLossLimit" value="3" min="2" max="10">
                                    <span class="input-group-text">회</span>
                                </div>
                                <div class="form-text">연속 손실 시 거래 일시 중지</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">쿨다운 시간</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="cooldownTime" value="30" min="5" max="120">
                                    <span class="input-group-text">분</span>
                                </div>
                                <div class="form-text">연속 손실 후 거래 재개까지 대기 시간</div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 거래 시간 설정 -->
            <div class="card bg-dark border-secondary shadow-sm mb-4">
                <div class="card-header bg-secondary">
                    <h5 class="mb-0">
                        <i class="bi bi-clock me-2"></i>거래 시간 설정
                    </h5>
                </div>
                <div class="card-body">
                    <form id="timeForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableTimeFilter">
                                    <label class="form-check-label fw-medium" for="enableTimeFilter">
                                        거래 시간 제한
                                    </label>
                                </div>
                                <div class="form-text">특정 시간대에만 거래 실행</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">루프 간격</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="loopDelay" value="60" min="10" max="300">
                                    <span class="input-group-text">초</span>
                                </div>
                                <div class="form-text">매매 로직 실행 간격</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">거래 시작 시간</label>
                                <input type="time" class="form-control" id="tradingStartTime" value="09:00">
                                <div class="form-text">하루 거래 시작 시간</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">거래 종료 시간</label>
                                <input type="time" class="form-control" id="tradingEndTime" value="23:00">
                                <div class="form-text">하루 거래 종료 시간</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label fw-medium">거래 제외 요일</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="excludeSunday">
                                            <label class="form-check-label" for="excludeSunday">일요일</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="excludeMonday">
                                            <label class="form-check-label" for="excludeMonday">월요일</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="excludeTuesday">
                                            <label class="form-check-label" for="excludeTuesday">화요일</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="excludeWednesday">
                                            <label class="form-check-label" for="excludeWednesday">수요일</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="excludeThursday">
                                            <label class="form-check-label" for="excludeThursday">목요일</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="excludeFriday">
                                            <label class="form-check-label" for="excludeFriday">금요일</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="excludeSaturday">
                                            <label class="form-check-label" for="excludeSaturday">토요일</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-text">선택된 요일에는 거래를 실행하지 않습니다</div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 알림 설정 -->
            <div class="card notification-card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-bell me-2"></i>알림 설정
                    </h5>
                </div>
                <div class="card-body">
                    <form id="notificationForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableTelegram" checked>
                                    <label class="form-check-label fw-medium" for="enableTelegram">
                                        텔레그램 알림
                                    </label>
                                </div>
                                <div class="form-text">매매 및 시스템 상태 알림</div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableEmail">
                                    <label class="form-check-label fw-medium" for="enableEmail">
                                        이메일 알림
                                    </label>
                                </div>
                                <div class="form-text">중요 이벤트 이메일 알림</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">알림 빈도</label>
                                <select class="form-select" id="notificationFrequency">
                                    <option value="all" selected>모든 거래</option>
                                    <option value="important">중요 이벤트만</option>
                                    <option value="summary">일일 요약</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">수익 알림 기준</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="profitNotification" value="1000" min="100">
                                    <span class="input-group-text">원</span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 우측: 상태 및 정보 -->
        <div class="col-lg-4">
            <!-- 현재 상태 -->
            <div class="card bg-dark border-secondary shadow-sm mb-4">
                <div class="card-header bg-secondary">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>현재 상태
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>설정 상태</span>
                        <span class="badge bg-success">저장됨</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>마지막 저장</span>
                        <span class="text-muted" id="lastSaved">방금 전</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>설정 파일</span>
                        <span class="text-success">
                            <i class="bi bi-check-circle"></i>
                        </span>
                    </div>
                    
                    <hr>
                    
                    <h6 class="mb-3">빠른 설정</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="applyConservative()">
                            <i class="bi bi-shield me-1"></i>보수적 설정
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="applyBalanced()">
                            <i class="bi bi-bar-chart me-1"></i>균형 설정
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="applyAggressive()">
                            <i class="bi bi-lightning me-1"></i>공격적 설정
                        </button>
                    </div>
                </div>
            </div>

            <!-- 설정 도움말 -->
            <div class="card help-card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-question-circle me-2"></i>설정 도움말
                    </h5>
                </div>
                <div class="card-body">
                    <div class="accordion accordion-flush" id="helpAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help1">
                                    매매 모드
                                </button>
                            </h2>
                            <div id="help1" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <small>데모 모드는 실제 자금 없이 가상으로 매매를 테스트할 수 있습니다. 실제 매매 전에 충분한 테스트를 권장합니다.</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help2">
                                    리스크 관리
                                </button>
                            </h2>
                            <div id="help2" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <small>리스크 관리 설정은 손실을 제한하고 안전한 거래를 위해 중요합니다. 보수적인 설정으로 시작하는 것을 권장합니다.</small>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help3">
                                    적응형 임계값
                                </button>
                            </h2>
                            <div id="help3" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <small>적응형 임계값은 시장 변동성에 따라 매매 기준을 자동으로 조정합니다. 변동성이 높을 때는 임계값이 높아집니다.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 설정 저장
    function saveSettings() {
        // TODO: API 연동
        alert('설정이 저장되었습니다.');
        document.getElementById('lastSaved').textContent = '방금 전';
    }
    
    // 기본값 복원
    function resetSettings() {
        if (confirm('모든 설정을 기본값으로 복원하시겠습니까?')) {
            // 기본 매매 설정
            document.getElementById('tradingMode').value = 'demo';
            document.getElementById('virtualBalance').value = 10000;
            document.getElementById('initialPosition').value = 0.05;
            document.getElementById('adjustmentSize').value = 0.01;
            document.getElementById('baseThreshold').value = 1000;
            document.getElementById('consecutiveThreshold').value = 4;
            document.getElementById('adaptiveThreshold').checked = true;
            document.getElementById('volatilityWindow').value = 20;
            
            // 리스크 관리 설정
            document.getElementById('maxLossLimit').value = 5;
            document.getElementById('dailyTradeLimit').value = 10;
            document.getElementById('maxPositionSize').value = 0.5;
            document.getElementById('emergencyStopEnabled').checked = true;
            document.getElementById('consecutiveLossLimit').value = 3;
            document.getElementById('cooldownTime').value = 30;
            
            // 거래 시간 설정
            document.getElementById('enableTimeFilter').checked = false;
            document.getElementById('loopDelay').value = 60;
            document.getElementById('tradingStartTime').value = '09:00';
            document.getElementById('tradingEndTime').value = '23:00';
            
            alert('기본값으로 복원되었습니다.');
        }
    }
    
    // 빠른 설정 함수들
    function applyConservative() {
        // 보수적 설정
        document.getElementById('initialPosition').value = 0.03;
        document.getElementById('adjustmentSize').value = 0.005;
        document.getElementById('baseThreshold').value = 1500;
        document.getElementById('maxLossLimit').value = 3;
        document.getElementById('dailyTradeLimit').value = 5;
        document.getElementById('consecutiveLossLimit').value = 2;
        alert('보수적 설정이 적용되었습니다.');
    }
    
    function applyBalanced() {
        // 균형 설정
        document.getElementById('initialPosition').value = 0.05;
        document.getElementById('adjustmentSize').value = 0.01;
        document.getElementById('baseThreshold').value = 1000;
        document.getElementById('maxLossLimit').value = 5;
        document.getElementById('dailyTradeLimit').value = 10;
        document.getElementById('consecutiveLossLimit').value = 3;
        alert('균형 설정이 적용되었습니다.');
    }
    
    function applyAggressive() {
        // 공격적 설정
        document.getElementById('initialPosition').value = 0.08;
        document.getElementById('adjustmentSize').value = 0.02;
        document.getElementById('baseThreshold').value = 500;
        document.getElementById('maxLossLimit').value = 8;
        document.getElementById('dailyTradeLimit').value = 20;
        document.getElementById('consecutiveLossLimit').value = 5;
        alert('공격적 설정이 적용되었습니다.');
    }
    
    // 거래 시간 제한 토글
    document.getElementById('enableTimeFilter').addEventListener('change', function() {
        const timeInputs = document.querySelectorAll('#tradingStartTime, #tradingEndTime');
        const dayCheckboxes = document.querySelectorAll('[id^="exclude"]');
        
        timeInputs.forEach(input => {
            input.disabled = !this.checked;
        });
        
        dayCheckboxes.forEach(checkbox => {
            checkbox.disabled = !this.checked;
        });
    });
    
    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function() {
        // 거래 시간 제한이 비활성화된 경우 관련 요소들 비활성화
        const enableTimeFilter = document.getElementById('enableTimeFilter');
        if (!enableTimeFilter.checked) {
            enableTimeFilter.dispatchEvent(new Event('change'));
        }
    });
</script>
{% endblock %}