<!-- 파일 경로: web/templates/settings.html -->
<!-- 코드명: 설정 페이지 템플릿 (압축 + JS 분리) -->

{% extends "base.html" %}

{% block title %}NHBot - 설정{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 페이지 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0"><i class="bi bi-gear me-2"></i>설정</h2>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="resetSettings()" id="resetBtn">
                <i class="bi bi-arrow-clockwise me-1"></i>기본값 복원
            </button>
            <button class="btn btn-primary" onclick="saveSettings()" id="saveBtn">
                <i class="bi bi-check-lg me-1"></i>설정 저장
            </button>
        </div>
    </div>

    <!-- 로딩 오버레이 -->
    <div id="loadingOverlay" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50" style="z-index: 9999;">
        <div class="position-absolute top-50 start-50 translate-middle text-center">
            <div class="spinner-border text-primary mb-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="text-white">설정 처리 중...</div>
        </div>
    </div>

    <!-- 알림 메시지 -->
    <div id="alertContainer"></div>

    <div class="row">
        <!-- 좌측: 설정 폼들 -->
        <div class="col-lg-8">
            <!-- 기본 매매 설정 -->
            <div class="card bg-dark border-secondary shadow-sm mb-4">
                <div class="card-header bg-secondary">
                    <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>기본 매매 설정</h5>
                </div>
                <div class="card-body">
                    <form id="tradingForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">매매 모드</label>
                                <select class="form-select" id="demo_mode">
                                    <option value="true">📊 데모 매매</option>
                                    <option value="false">💰 실제 매매</option>
                                </select>
                                <div class="form-text">데모 모드에서는 가상 자금으로 매매가 진행됩니다</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">가상 잔고 (USDT)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="virtual_balance" min="1000" max="1000000">
                                    <span class="input-group-text">USDT</span>
                                </div>
                                <div class="form-text">데모 모드에서 사용할 가상 자금</div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">초기 포지션 크기</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="initial_position_size" step="0.001" min="0.001" max="1">
                                    <span class="input-group-text">BTC</span>
                                </div>
                                <div class="form-text">첫 매매 시 진입할 포지션 크기</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">조정 크기</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="adjustment_size" step="0.001" min="0.001" max="0.1">
                                    <span class="input-group-text">BTC</span>
                                </div>
                                <div class="form-text">추가 매매 시 조정할 포지션 크기</div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">기본 임계값</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="base_threshold" min="100" max="10000">
                                    <span class="input-group-text">USDT</span>
                                </div>
                                <div class="form-text">매매 신호를 발생시킬 가격 변동 기준</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">연속 신호 기준</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="consecutive_threshold" min="2" max="10">
                                    <span class="input-group-text">회</span>
                                </div>
                                <div class="form-text">연속 신호 후 대응 매매를 실행할 기준</div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="adaptive_threshold_enabled">
                                    <label class="form-check-label fw-medium" for="adaptive_threshold_enabled">적응형 임계값 사용</label>
                                </div>
                                <div class="form-text">시장 변동성에 따른 임계값 자동 조정</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">변동성 윈도우</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="volatility_window" min="5" max="100">
                                    <span class="input-group-text">일</span>
                                </div>
                                <div class="form-text">변동성 계산에 사용할 기간</div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">루프 간격</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="loop_delay" min="10" max="300">
                                    <span class="input-group-text">초</span>
                                </div>
                                <div class="form-text">매매 로직 실행 간격</div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- AI 설정 -->
            <div class="card bg-dark border-secondary shadow-sm mb-4">
                <div class="card-header bg-secondary">
                    <h5 class="mb-0"><i class="bi bi-brain me-2"></i>AI 설정</h5>
                </div>
                <div class="card-body">
                    <form id="aiForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="ai_enabled">
                                    <label class="form-check-label fw-medium" for="ai_enabled">AI 모델 사용</label>
                                </div>
                                <div class="form-text">AI 예측을 매매 결정에 반영</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">메인 시간대</label>
                                <select class="form-select" id="main_interval">
                                    <option value="1">1분봉</option>
                                    <option value="5">5분봉</option>
                                    <option value="15">15분봉</option>
                                    <option value="60">1시간봉</option>
                                </select>
                                <div class="form-text">주요 매매 판단 기준 시간대</div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">AI 학습 기간</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="training_days" min="30" max="1095">
                                    <span class="input-group-text">일</span>
                                </div>
                                <div class="form-text">AI 학습에 사용할 과거 데이터 기간</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">모델 재훈련 간격</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="retrain_interval_days" min="1" max="30">
                                    <span class="input-group-text">일</span>
                                </div>
                                <div class="form-text">자동 재훈련 실행 간격</div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 리스크 관리 설정 -->
            <div class="card bg-dark border-secondary shadow-sm mb-4">
                <div class="card-header bg-secondary">
                    <h5 class="mb-0"><i class="bi bi-shield-check me-2"></i>리스크 관리 설정</h5>
                </div>
                <div class="card-body">
                    <form id="riskForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">최대 손실 한도</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="max_loss_percent" min="1" max="20" step="0.1">
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="form-text">전체 잔고 대비 최대 손실 허용 비율</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">일일 거래 한도</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="daily_trade_limit" min="1" max="100">
                                    <span class="input-group-text">회</span>
                                </div>
                                <div class="form-text">하루 최대 거래 실행 횟수</div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">포지션 크기 상한</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="max_position_size" step="0.01" min="0.01" max="2">
                                    <span class="input-group-text">BTC</span>
                                </div>
                                <div class="form-text">단일 포지션의 최대 크기</div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" id="emergency_stop_enabled">
                                    <label class="form-check-label fw-medium" for="emergency_stop_enabled">긴급 정지 활성화</label>
                                </div>
                                <div class="form-text">비정상 상황 시 자동 거래 중지</div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">연속 손실 제한</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="consecutive_loss_limit" min="2" max="10">
                                    <span class="input-group-text">회</span>
                                </div>
                                <div class="form-text">연속 손실 시 거래 일시 중지</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">쿨다운 시간</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="cooldown_minutes" min="5" max="120">
                                    <span class="input-group-text">분</span>
                                </div>
                                <div class="form-text">연속 손실 후 거래 재개까지 대기 시간</div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 알림 설정 -->
            <div class="card notification-card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-bell me-2"></i>알림 설정</h5>
                </div>
                <div class="card-body">
                    <form id="notificationForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="telegram_enabled">
                                    <label class="form-check-label fw-medium" for="telegram_enabled">텔레그램 알림</label>
                                </div>
                                <div class="form-text">매매 및 시스템 상태 알림</div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="email_enabled">
                                    <label class="form-check-label fw-medium" for="email_enabled">이메일 알림</label>
                                </div>
                                <div class="form-text">중요 이벤트 이메일 알림</div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">알림 빈도</label>
                                <select class="form-select" id="frequency">
                                    <option value="all">모든 거래</option>
                                    <option value="important">중요 이벤트만</option>
                                    <option value="summary">일일 요약</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">수익 알림 기준</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="profit_threshold_krw" min="100">
                                    <span class="input-group-text">원</span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 우측: 상태 및 정보 -->
        <div class="col-lg-4">
            <!-- 현재 상태 -->
            <div class="card bg-dark border-secondary shadow-sm mb-4">
                <div class="card-header bg-secondary">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>현재 상태</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>설정 상태</span>
                        <span class="badge bg-secondary" id="configStatus">로딩 중</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>마지막 저장</span>
                        <span class="text-muted" id="lastSaved">-</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>설정 파일</span>
                        <span class="text-success"><i class="bi bi-check-circle"></i></span>
                    </div>
                    <hr>
                    <h6 class="mb-3">빠른 설정</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="applyPreset('conservative')">
                            <i class="bi bi-shield me-1"></i>보수적 설정
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="applyPreset('balanced')">
                            <i class="bi bi-bar-chart me-1"></i>균형 설정
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="applyPreset('aggressive')">
                            <i class="bi bi-lightning me-1"></i>공격적 설정
                        </button>
                    </div>
                </div>
            </div>

            <!-- 설정 도움말 -->
            <div class="card help-card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-question-circle me-2"></i>설정 도움말</h5>
                </div>
                <div class="card-body">
                    <div class="accordion accordion-flush" id="helpAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help1">매매 모드</button>
                            </h2>
                            <div id="help1" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <small>데모 모드는 실제 자금 없이 가상으로 매매를 테스트할 수 있습니다. 실제 매매 전에 충분한 테스트를 권장합니다.</small>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help2">리스크 관리</button>
                            </h2>
                            <div id="help2" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <small>리스크 관리 설정은 손실을 제한하고 안전한 거래를 위해 중요합니다. 보수적인 설정으로 시작하는 것을 권장합니다.</small>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help3">AI 모델</button>
                            </h2>
                            <div id="help3" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <small>AI 모델은 원웨이 장에서의 손실을 최소화하기 위해 매매 타이밍을 정교하게 판단합니다. 15분봉 기준을 권장합니다.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/common.js') }}"></script>
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
{% endblock %}