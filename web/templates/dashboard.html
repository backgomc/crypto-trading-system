<!-- web/templates/dashboard.html -->
{% extends "base.html" %}

{% block title %}ëŒ€ì‹œë³´ë“œ - ìë™ë§¤ë§¤{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="d-flex justify-content-between align-items-center mb-4 page-header">
        <h2 class="mb-0">
            <i class="bi bi-speedometer2 me-2"></i>ëŒ€ì‹œë³´ë“œ
        </h2>
        <div class="current-time">
            <i class="bi bi-clock me-1"></i>
            <span id="currentTime"></span>
        </div>
    </div>

    <!-- ìƒíƒœ ì¹´ë“œë“¤ -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card status-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>ì‹œìŠ¤í…œ ìƒíƒœ</h6>
                            <h4 id="systemStatus" class="text-danger">ì¤‘ì§€ë¨</h4>
                        </div>
                        <div class="card-icon text-danger">
                            <i class="bi bi-power" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card status-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>ì´ ì”ê³ </h6>
                            <h4 id="totalBalance" class="text-primary">10,000,000ì›</h4>
                        </div>
                        <div class="card-icon text-primary">
                            <i class="bi bi-wallet2" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card status-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>ì˜¤ëŠ˜ ìˆ˜ìµ</h6>
                            <h4 id="todayProfit" class="text-success">+150,000ì›</h4>
                        </div>
                        <div class="card-icon text-success">
                            <i class="bi bi-graph-up-arrow" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card status-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>ìˆ˜ìµë¥ </h6>
                            <h4 id="profitRate" class="text-success">+1.5%</h4>
                        </div>
                        <div class="card-icon text-success">
                            <i class="bi bi-percent" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- ì¢Œì¸¡: ì°¨íŠ¸ + ì œì–´íŒ -->
        <div class="col-lg-8 mb-4">
            <!-- ì°¨íŠ¸ ì˜ì—­ -->
            <div class="card main-card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>ë¹„íŠ¸ì½”ì¸ ì°¨íŠ¸
                    </h5>
                    <div class="chart-controls">
                        <select id="chartSymbol" class="form-select form-select-sm me-2" style="width: auto;" onchange="changeSymbol()">
                            <option value="BTCUSDT">BTC/USDT</option>
                            <option value="ETHUSDT">ETH/USDT</option>
                            <option value="ADAUSDT">ADA/USDT</option>
                            <option value="SOLUSDT">SOL/USDT</option>
                        </select>
                        <select id="chartInterval" class="form-select form-select-sm" style="width: auto;" onchange="changeInterval()">
                            <option value="1m">1ë¶„</option>
                            <option value="5m">5ë¶„</option>
                            <option value="15m" selected>15ë¶„</option>
                            <option value="1h">1ì‹œê°„</option>
                            <option value="4h">4ì‹œê°„</option>
                            <option value="1d">1ì¼</option>
                        </select>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Lightweight Charts ì»¨í…Œì´ë„ˆ -->
                    <div id="trading-chart" style="height: 600px; width: 100%;"></div>
                </div>
            </div>

            <!-- ì œì–´ ë²„íŠ¼ë“¤ -->
            <div class="card main-card">
                <div class="card-header">
                    <h5>
                        <i class="bi bi-gear me-2"></i>ì œì–´íŒ
                    </h5>
                </div>
                <div class="card-body control-buttons">
                    <div class="row g-3">
                        <div class="col-6 col-md-3">
                            <button class="btn btn-success w-100" onclick="startTrading()">
                                <i class="bi bi-play-fill me-1"></i>ì‹œì‘
                            </button>
                        </div>
                        <div class="col-6 col-md-3">
                            <button class="btn btn-danger w-100" onclick="stopTrading()">
                                <i class="bi bi-stop-fill me-1"></i>ì¤‘ë‹¨
                            </button>
                        </div>
                        <div class="col-6 col-md-3">
                            <button class="btn btn-warning w-100" onclick="trainAI()">
                                <i class="bi bi-brain me-1"></i>AI í•™ìŠµ
                            </button>
                        </div>
                        <div class="col-6 col-md-3">
                            <button class="btn btn-outline-danger w-100" onclick="emergencyStop()">
                                <i class="bi bi-exclamation-triangle me-1"></i>ê¸´ê¸‰ ì²­ì‚°
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìš°ì¸¡: í¬ì§€ì…˜ ë° ì •ë³´ -->
        <div class="col-lg-4">
            <!-- í¬ì§€ì…˜ í˜„í™© -->
            <div class="card main-card mb-4">
                <div class="card-header">
                    <h5>
                        <i class="bi bi-pie-chart me-2"></i>í¬ì§€ì…˜ í˜„í™©
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <div class="position-box long-position">
                                <h6 class="text-success mb-1">ë¡± í¬ì§€ì…˜</h6>
                                <p id="longSize" class="mb-1">0.05 BTC</p>
                                <small id="longAvgPrice">@ 95,000,000ì›</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="position-box short-position">
                                <h6 class="text-danger mb-1">ìˆ í¬ì§€ì…˜</h6>
                                <p id="shortSize" class="mb-1">0.05 BTC</p>
                                <small id="shortAvgPrice">@ 95,000,000ì›</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="total-pnl">
                        <h6>ì´ ë¯¸ì‹¤í˜„ ì†ìµ</h6>
                        <h4 id="totalPnl">+150,000ì›</h4>
                        <small id="totalPnlPercent">+1.5%</small>
                    </div>
                </div>
            </div>

            <!-- AI ìƒíƒœ -->
            <div class="card main-card mb-4">
                <div class="card-header">
                    <h5>
                        <i class="bi bi-brain me-2"></i>AI ëª¨ë¸ ìƒíƒœ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="ai-status-item d-flex justify-content-between align-items-center">
                        <span>ëª¨ë¸ ìƒíƒœ</span>
                        <span id="aiStatus" class="badge bg-warning">ëŒ€ê¸°ì¤‘</span>
                    </div>
                    <div class="ai-status-item d-flex justify-content-between align-items-center">
                        <span>ë§ˆì§€ë§‰ í•™ìŠµ</span>
                        <span id="lastTraining" class="text-muted">2ì‹œê°„ ì „</span>
                    </div>
                    <div class="ai-status-item d-flex justify-content-between align-items-center">
                        <span>ì •í™•ë„</span>
                        <span id="aiAccuracy" class="text-success">85.3%</span>
                    </div>
                    <div class="ai-progress mt-2">
                        <div id="aiProgressBar" class="progress-bar" style="width: 85.3%"></div>
                    </div>
                </div>
            </div>

            <!-- ìµœê·¼ ê±°ë˜ -->
            <div class="card main-card">
                <div class="card-header">
                    <h5>
                        <i class="bi bi-clock-history me-2"></i>ìµœê·¼ ê±°ë˜
                    </h5>
                </div>
                <div class="card-body" id="recentTrades">
                    <div class="recent-trade d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-success">ë§¤ìˆ˜</span>
                            <span class="ms-2">0.01 BTC</span>
                        </div>
                        <small>10ë¶„ ì „</small>
                    </div>
                    <div class="recent-trade d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-danger">ë§¤ë„</span>
                            <span class="ms-2">0.01 BTC</span>
                        </div>
                        <small>1ì‹œê°„ ì „</small>
                    </div>
                    <div class="recent-trade d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-success">ë§¤ìˆ˜</span>
                            <span class="ms-2">0.02 BTC</span>
                        </div>
                        <small>3ì‹œê°„ ì „</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Lightweight Charts ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì•ˆì •ì ì¸ ë²„ì „) -->
<script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>

<script>
    // ì „ì—­ ë³€ìˆ˜ë“¤
    let chart = null;
    let candlestickSeries = null;
    let currentSymbol = 'BTCUSDT';
    let currentInterval = '15m';
    let markers = [];
    let longAvgLine = null;
    let shortAvgLine = null;
    
    // ìë™ë§¤ë§¤ í¬ì§€ì…˜ ë°ì´í„° (ì‹¤ì œ ë°ì´í„°ë¡œ ìˆ˜ì •)
    let tradingData = {
        longPosition: {
            size: 0.05,
            avgPrice: 100000000,  // 1ì–µì› (ì‹¤ì œ ë¹„íŠ¸ì½”ì¸ ê°€ê²© ê·¼ì²˜)
            pnl: 75000
        },
        shortPosition: {
            size: 0.05,
            avgPrice: 102000000,  // 1ì–µ2ì²œë§Œì›
            pnl: 75000
        },
        trades: [
            // ê³ ì •ëœ ë§¤ë§¤ ë‚´ì—­ë§Œ í‘œì‹œ
        ]
    };
    
    // ì°¨íŠ¸ ì´ˆê¸°í™”
    function initChart() {
        console.log('ğŸ¯ initChart í•¨ìˆ˜ ì‹œì‘');
        
        const container = document.getElementById('trading-chart');
        if (!container) {
            console.error('âŒ ì°¨íŠ¸ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
            return;
        }
        
        console.log('ğŸ“¦ ì»¨í…Œì´ë„ˆ í¬ê¸°:', container.clientWidth, 'x', container.clientHeight);
        
        try {
            // ì°¨íŠ¸ ìƒì„± (ì˜¬ë°”ë¥¸ ë°©ë²•)
            console.log('ì°¨íŠ¸ ìƒì„± ì‹œë„...');
            chart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: 600,
                layout: {
                    backgroundColor: '#1e1e1e',
                    textColor: '#d1d4dc',
                },
                grid: {
                    vertLines: { 
                        color: '#2b2b43' 
                    },
                    horzLines: { 
                        color: '#2b2b43' 
                    },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                priceScale: {
                    borderColor: '#485c7b',
                },
                timeScale: {
                    borderColor: '#485c7b',
                    timeVisible: true,
                    secondsVisible: false,
                },
            });
            
            console.log('âœ… ì°¨íŠ¸ ê°ì²´ ìƒì„± ì™„ë£Œ');
            console.log('chart ê°ì²´:', chart);
            console.log('chart ë©”ì„œë“œë“¤:', Object.getOwnPropertyNames(chart));
            
            // ìº”ë“¤ìŠ¤í‹± ì‹œë¦¬ì¦ˆ ì¶”ê°€ (ë²„ì „ë³„ ëŒ€ì‘)
            try {
                candlestickSeries = chart.addCandlestickSeries({
                    upColor: '#26a69a',
                    downColor: '#ef5350',
                    borderVisible: false,
                    wickUpColor: '#26a69a',
                    wickDownColor: '#ef5350',
                });
                console.log('âœ… ìº”ë“¤ìŠ¤í‹± ì‹œë¦¬ì¦ˆ ì¶”ê°€ ì™„ë£Œ (addCandlestickSeries)');
            } catch (seriesError) {
                console.log('addCandlestickSeries ì‹¤íŒ¨, ë‹¤ë¥¸ ë°©ë²• ì‹œë„...');
                console.error('ì‹œë¦¬ì¦ˆ ì—ëŸ¬:', seriesError);
                
                // ëŒ€ì•ˆ ë°©ë²• ì‹œë„
                try {
                    candlestickSeries = chart.addSeries('Candlestick', {
                        upColor: '#26a69a',
                        downColor: '#ef5350',
                        borderVisible: false,
                        wickUpColor: '#26a69a',
                        wickDownColor: '#ef5350',
                    });
                    console.log('âœ… ìº”ë“¤ìŠ¤í‹± ì‹œë¦¬ì¦ˆ ì¶”ê°€ ì™„ë£Œ (addSeries)');
                } catch (altError) {
                    console.error('ëŒ€ì•ˆ ë°©ë²•ë„ ì‹¤íŒ¨:', altError);
                    throw altError;
                }
            }
            
            console.log('âœ… ìº”ë“¤ìŠ¤í‹± ì‹œë¦¬ì¦ˆ ì¶”ê°€ ì™„ë£Œ');
            
            // ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ
            loadChartData();
            
            // í¬ì§€ì…˜ í‰ë‹¨ê°€ ë¼ì¸ í‘œì‹œ
            updatePositionLines();
            
            // ë§¤ë§¤ ë§ˆì»¤ í‘œì‹œ
            updateTradingMarkers();
            
            // ì‹¤ì‹œê°„ ê°€ê²© ì—…ë°ì´íŠ¸ ì‹œì‘
            setTimeout(() => {
                startRealTimeUpdates();
            }, 3000);
            
            // ë°˜ì‘í˜• ì°¨íŠ¸ í¬ê¸° ì¡°ì •
            window.addEventListener('resize', handleResize);
            
            console.log('ğŸ‰ ì°¨íŠ¸ ì´ˆê¸°í™” ì™„ì „ ì™„ë£Œ!');
            
        } catch (error) {
            console.error('âŒ ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #1e1e1e; color: white;">
                    <div style="text-align: center;">
                        <h5>âŒ ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨</h5>
                        <p>${error.message}</p>
                        <button onclick="location.reload()" class="btn btn-primary">ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>
            `;
        }
    }
    
    // ì‹¤ì œ ë¹„íŠ¸ì½”ì¸ ê°€ê²© ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë” ì•ˆì •ì ì¸ ë°©ë²•)
    async function loadChartData() {
        try {
            console.log('ğŸ“Š ìµœì‹  ë¹„íŠ¸ì½”ì¸ ë°ì´í„° ë¡œë“œ ì‹œì‘...');
            console.log('í˜„ì¬ ì‹¬ë³¼:', currentSymbol, 'ì¸í„°ë²Œ:', currentInterval);
            
            // ë°”ì´ë‚¸ìŠ¤ API ì‚¬ìš© (ë” ì•ˆì •ì )
            const binanceInterval = convertToBinanceInterval(currentInterval);
            const binanceSymbol = currentSymbol.replace('USDT', 'USDT'); // ë°”ì´ë‚¸ìŠ¤ í˜•ì‹
            
            const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${binanceSymbol}&interval=${binanceInterval}&limit=200`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('ğŸ“ˆ ë°”ì´ë‚¸ìŠ¤ API ì‘ë‹µ:', data.length, 'ê°œ ìº”ë“¤');
            
            if (data && data.length > 0) {
                const klineData = data.map(item => ({
                    time: parseInt(item[0]) / 1000, // timestampë¥¼ ì´ˆë¡œ ë³€í™˜
                    open: parseFloat(item[1]),
                    high: parseFloat(item[2]), 
                    low: parseFloat(item[3]),
                    close: parseFloat(item[4])
                }));
                
                const latestPrice = klineData[klineData.length - 1]?.close;
                console.log('âœ… ìµœì‹  ë¹„íŠ¸ì½”ì¸ ê°€ê²©:', latestPrice?.toLocaleString(), 'USDT');
                console.log('ğŸ“… ìµœì‹  ì‹œê°„:', new Date(klineData[klineData.length - 1]?.time * 1000));
                
                if (candlestickSeries && klineData.length > 0) {
                    candlestickSeries.setData(klineData);
                    console.log('âœ… ì°¨íŠ¸ ë°ì´í„° ì„¤ì • ì™„ë£Œ');
                    
                    // ì°¨íŠ¸ë¥¼ ìµœì‹  ë°ì´í„°ë¡œ ìŠ¤í¬ë¡¤
                    chart.timeScale().scrollToRealTime();
                }
            } else {
                throw new Error('ë¹ˆ ë°ì´í„° ì‘ë‹µ');
            }
            
        } catch (error) {
            console.error('âŒ ë°”ì´ë‚¸ìŠ¤ API ì‹¤íŒ¨:', error);
            console.log('ğŸ”„ Bybit APIë¡œ ì¬ì‹œë„...');
            
            try {
                // Bybit API ë°±ì—…
                const response = await fetch(`https://api.bybit.com/v5/market/kline?category=spot&symbol=${currentSymbol}&interval=${currentInterval}&limit=200`);
                const data = await response.json();
                
                if (data.retCode === 0 && data.result && data.result.list) {
                    const klineData = data.result.list.map(item => ({
                        time: parseInt(item[0]) / 1000,
                        open: parseFloat(item[1]),
                        high: parseFloat(item[2]), 
                        low: parseFloat(item[3]),
                        close: parseFloat(item[4])
                    })).reverse();
                    
                    console.log('âœ… Bybit ë°±ì—… ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', klineData.length, 'ê°œ');
                    console.log('ğŸ“ˆ ìµœì‹  ê°€ê²©:', klineData[klineData.length - 1]?.close);
                    
                    candlestickSeries.setData(klineData);
                    chart.timeScale().scrollToRealTime();
                } else {
                    throw new Error('Bybit API ì‘ë‹µ ì˜¤ë¥˜');
                }
                
            } catch (bybitError) {
                console.error('âŒ Bybit APIë„ ì‹¤íŒ¨:', bybitError);
                console.log('ğŸ›¡ï¸ í˜„ì‹¤ì ì¸ ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©');
                
                // í˜„ì¬ ì‹¤ì œ ë¹„íŠ¸ì½”ì¸ ê°€ê²© ê·¼ì²˜ë¡œ ìƒ˜í”Œ ë°ì´í„° ìƒì„±
                const realisticData = generateRealisticBitcoinData();
                candlestickSeries.setData(realisticData);
            }
        }
    }
    
    // ë°”ì´ë‚¸ìŠ¤ ì¸í„°ë²Œ ë³€í™˜
    function convertToBinanceInterval(interval) {
        const intervalMap = {
            '1m': '1m',
            '5m': '5m', 
            '15m': '15m',
            '1h': '1h',
            '4h': '4h',
            '1d': '1d'
        };
        return intervalMap[interval] || '15m';
    }
    
    // í˜„ì‹¤ì ì¸ ë¹„íŠ¸ì½”ì¸ ë°ì´í„° ìƒì„± (2025ë…„ 7ì›” ê¸°ì¤€)
    function generateRealisticBitcoinData() {
        const data = [];
        let currentPrice = 67000; // í˜„ì¬ ì‹¤ì œ ë¹„íŠ¸ì½”ì¸ ê°€ê²© ê·¼ì²˜ (USD)
        const now = new Date();
        
        console.log('ğŸ¯ í˜„ì‹¤ì ì¸ ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì¤‘... ê¸°ì¤€ ê°€ê²©:', currentPrice, 'USD');
        
        for (let i = 200; i >= 0; i--) {
            const time = new Date(now.getTime() - i * getIntervalMs());
            
            // í˜„ì‹¤ì ì¸ ë¹„íŠ¸ì½”ì¸ ê°€ê²© ë³€ë™ (Â±0.5% ~ 2% ë‚´ì™¸)
            const volatility = 0.005 + Math.random() * 0.015; // 0.5% ~ 2% ë³€ë™ì„±
            const direction = Math.random() > 0.5 ? 1 : -1;
            const change = currentPrice * volatility * direction;
            
            const open = currentPrice;
            const close = Math.max(currentPrice + change, 45000); // ìµœì†Œ $45,000
            const high = Math.max(open, close) * (1 + Math.random() * 0.01); // ìµœëŒ€ 1% ìœ„
            const low = Math.min(open, close) * (1 - Math.random() * 0.01); // ìµœëŒ€ 1% ì•„ë˜
            
            data.push({
                time: Math.floor(time.getTime() / 1000),
                open: Math.round(open * 100) / 100,
                high: Math.round(high * 100) / 100,
                low: Math.round(low * 100) / 100,
                close: Math.round(close * 100) / 100
            });
            
            currentPrice = close;
        }
        
        console.log('ğŸ“Š ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì™„ë£Œ - ìµœì¢… ê°€ê²©:', currentPrice.toFixed(2), 'USD');
        return data;
    }
    
    // ì¸í„°ë²Œë³„ ë°€ë¦¬ì´ˆ ë³€í™˜
    function getIntervalMs() {
        const intervalMap = {
            '1m': 60 * 1000,
            '5m': 5 * 60 * 1000,
            '15m': 15 * 60 * 1000,
            '1h': 60 * 60 * 1000,
            '4h': 4 * 60 * 60 * 1000,
            '1d': 24 * 60 * 60 * 1000
        };
        return intervalMap[currentInterval] || 15 * 60 * 1000;
    }
    
    // í¬ì§€ì…˜ í‰ë‹¨ê°€ ë¼ì¸ ì—…ë°ì´íŠ¸
    function updatePositionLines() {
        console.log('ğŸ¯ í¬ì§€ì…˜ í‰ë‹¨ê°€ ë¼ì¸ ì—…ë°ì´íŠ¸ ì¤‘...');
        console.log('Long Position:', tradingData.longPosition);
        console.log('Short Position:', tradingData.shortPosition);
        
        // ê¸°ì¡´ ë¼ì¸ ì œê±°
        if (longAvgLine) {
            candlestickSeries.removePriceLine(longAvgLine);
            console.log('ê¸°ì¡´ ë¡± ë¼ì¸ ì œê±°ë¨');
        }
        if (shortAvgLine) {
            candlestickSeries.removePriceLine(shortAvgLine);
            console.log('ê¸°ì¡´ ìˆ ë¼ì¸ ì œê±°ë¨');
        }
        
        // ë¡± í¬ì§€ì…˜ í‰ë‹¨ê°€ ë¼ì¸ (ì´ˆë¡ìƒ‰)
        if (tradingData.longPosition.size > 0) {
            longAvgLine = candlestickSeries.createPriceLine({
                price: tradingData.longPosition.avgPrice,
                color: '#00ff00',
                lineWidth: 3,
                lineStyle: LightweightCharts.LineStyle.Solid,
                axisLabelVisible: true,
                title: `ğŸŸ¢ Long Avg: ${formatPrice(tradingData.longPosition.avgPrice)}ì›`
            });
            console.log('âœ… ë¡± í‰ë‹¨ê°€ ë¼ì¸ ìƒì„±:', tradingData.longPosition.avgPrice);
        }
        
        // ìˆ í¬ì§€ì…˜ í‰ë‹¨ê°€ ë¼ì¸ (ë¹¨ê°„ìƒ‰)
        if (tradingData.shortPosition.size > 0) {
            shortAvgLine = candlestickSeries.createPriceLine({
                price: tradingData.shortPosition.avgPrice,
                color: '#ff0000',
                lineWidth: 3,
                lineStyle: LightweightCharts.LineStyle.Solid,
                axisLabelVisible: true,
                title: `ğŸ”´ Short Avg: ${formatPrice(tradingData.shortPosition.avgPrice)}ì›`
            });
            console.log('âœ… ìˆ í‰ë‹¨ê°€ ë¼ì¸ ìƒì„±:', tradingData.shortPosition.avgPrice);
        }
    }
    
    // ë§¤ë§¤ ë§ˆì»¤ ì—…ë°ì´íŠ¸
    function updateTradingMarkers() {
        console.log('ğŸ“Œ ë§¤ë§¤ ë§ˆì»¤ ì—…ë°ì´íŠ¸ ì¤‘...');
        console.log('ì´ ê±°ë˜ ìˆ˜:', tradingData.trades.length);
        
        markers = [];
        
        tradingData.trades.forEach((trade, index) => {
            const timestamp = new Date(trade.time).getTime() / 1000;
            
            const marker = {
                time: timestamp,
                position: trade.type === 'buy' ? 'belowBar' : 'aboveBar',
                color: trade.type === 'buy' ? '#00ff00' : '#ff0000',
                shape: trade.type === 'buy' ? 'arrowUp' : 'arrowDown',
                text: `${trade.type === 'buy' ? 'ğŸŸ¢ ë§¤ìˆ˜' : 'ğŸ”´ ë§¤ë„'} ${trade.amount} BTC\n${formatPrice(trade.price)}ì›`
            };
            
            markers.push(marker);
            console.log(`ë§ˆì»¤ ${index + 1}:`, marker.text);
        });
        
        console.log('âœ… ì´', markers.length, 'ê°œ ë§ˆì»¤ ì¶”ê°€ë¨');
        candlestickSeries.setMarkers(markers);
    }
    
    // ê°€ê²© í¬ë§·íŒ…
    function formatPrice(price) {
        return price.toLocaleString('ko-KR');
    }
    
    // ìƒˆë¡œìš´ ê±°ë˜ ì¶”ê°€
    function addNewTrade(type, price, amount) {
        const now = new Date();
        const newTrade = {
            time: now.toISOString().slice(0, 19).replace('T', ' '),
            type: type,
            price: price,
            amount: amount
        };
        
        tradingData.trades.push(newTrade);
        updateTradingMarkers();
        updateRecentTrades();
    }
    
    // ìµœê·¼ ê±°ë˜ ëª©ë¡ ì—…ë°ì´íŠ¸
    function updateRecentTrades() {
        const container = document.getElementById('recentTrades');
        container.innerHTML = '';
        
        const recentTrades = tradingData.trades.slice(-5).reverse();
        
        recentTrades.forEach(trade => {
            const timeAgo = getTimeAgo(new Date(trade.time));
            const div = document.createElement('div');
            div.className = 'recent-trade d-flex justify-content-between align-items-center';
            div.innerHTML = `
                <div>
                    <span class="badge ${trade.type === 'buy' ? 'bg-success' : 'bg-danger'}">${trade.type === 'buy' ? 'ë§¤ìˆ˜' : 'ë§¤ë„'}</span>
                    <span class="ms-2">${trade.amount} BTC</span>
                </div>
                <small>${timeAgo}</small>
            `;
            container.appendChild(div);
        });
    }
    
    // ì‹œê°„ ì°¨ì´ ê³„ì‚°
    function getTimeAgo(date) {
        const now = new Date();
        const diff = Math.floor((now - date) / 1000 / 60);
        
        if (diff < 1) return 'ë°©ê¸ˆ ì „';
        if (diff < 60) return `${diff}ë¶„ ì „`;
        if (diff < 1440) return `${Math.floor(diff / 60)}ì‹œê°„ ì „`;
        return `${Math.floor(diff / 1440)}ì¼ ì „`;
    }
    
    // ì‹¬ë³¼ ë³€ê²½
    function changeSymbol() {
        const symbol = document.getElementById('chartSymbol').value;
        currentSymbol = symbol;
        console.log('ğŸ”„ ì‹¬ë³¼ ë³€ê²½:', symbol);
        
        // ì°¨íŠ¸ ë°ì´í„° ìƒˆë¡œ ë¡œë“œ
        loadChartData();
    }
    
    // ì‹œê°„ëŒ€ ë³€ê²½
    function changeInterval() {
        const interval = document.getElementById('chartInterval').value;
        currentInterval = interval;
        console.log('ğŸ”„ ì¸í„°ë²Œ ë³€ê²½:', interval);
        
        // ì°¨íŠ¸ ë°ì´í„° ìƒˆë¡œ ë¡œë“œ
        loadChartData();
    }
    
    // ë°˜ì‘í˜• ì°¨íŠ¸ í¬ê¸° ì¡°ì •
    function handleResize() {
        const container = document.getElementById('trading-chart');
        if (chart) {
            chart.applyOptions({ width: container.clientWidth });
        }
    }
    
    // ì‹¤ì‹œê°„ ê°€ê²© ì—…ë°ì´íŠ¸ (ë” ê°„ë‹¨í•˜ê³  ì•ˆì •ì ì¸ ë°©ë²•)
    function startRealTimeUpdates() {
        console.log('ğŸ”„ ì‹¤ì‹œê°„ ê°€ê²© ì—…ë°ì´íŠ¸ ì‹œì‘...');
        
        // 30ì´ˆë§ˆë‹¤ ìµœì‹  ê°€ê²© ì—…ë°ì´íŠ¸
        setInterval(async () => {
            try {
                console.log('ğŸ“¡ ì‹¤ì‹œê°„ ê°€ê²© ì²´í¬...');
                
                // ë°”ì´ë‚¸ìŠ¤ ì‹¤ì‹œê°„ ê°€ê²© API
                const response = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${currentSymbol}`);
                const data = await response.json();
                
                if (data && data.price) {
                    const currentPrice = parseFloat(data.price);
                    const currentTime = Math.floor(Date.now() / 1000);
                    
                    console.log('ğŸ’° ì‹¤ì‹œê°„ ê°€ê²©:', currentPrice, 'USDT');
                    
                    // ë§ˆì§€ë§‰ ìº”ë“¤ ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„ ê°€ê²©ìœ¼ë¡œ)
                    if (candlestickSeries) {
                        // ê¸°ì¡´ ë°ì´í„°ì˜ ë§ˆì§€ë§‰ ìº”ë“¤ì„ í˜„ì¬ ê°€ê²©ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                        const lastCandle = {
                            time: currentTime - (currentTime % getIntervalSeconds()),
                            open: currentPrice * (0.999 + Math.random() * 0.002), // ì•½ê°„ì˜ ë³€ë™
                            high: currentPrice * (1 + Math.random() * 0.001),
                            low: currentPrice * (1 - Math.random() * 0.001),
                            close: currentPrice
                        };
                        
                        candlestickSeries.update(lastCandle);
                        console.log('ğŸ“ˆ ì°¨íŠ¸ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                    }
                }
                
            } catch (error) {
                console.error('âŒ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
        }, 30000); // 30ì´ˆë§ˆë‹¤
        
        // ì´ˆê¸° ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        setTimeout(async () => {
            try {
                const response = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${currentSymbol}`);
                const data = await response.json();
                
                if (data && data.price) {
                    console.log('ğŸ¯ í˜„ì¬ ì‹¤ì œ ë¹„íŠ¸ì½”ì¸ ê°€ê²©:', parseFloat(data.price), 'USDT');
                }
            } catch (error) {
                console.error('ì´ˆê¸° ê°€ê²© í™•ì¸ ì‹¤íŒ¨:', error);
            }
        }, 2000);
    }
    
    // ì¸í„°ë²Œì„ ì´ˆ ë‹¨ìœ„ë¡œ ë³€í™˜
    function getIntervalSeconds() {
        const intervalMap = {
            '1m': 60,
            '5m': 5 * 60,
            '15m': 15 * 60,
            '1h': 60 * 60,
            '4h': 4 * 60 * 60,
            '1d': 24 * 60 * 60
        };
        return intervalMap[currentInterval] || 15 * 60;
    }
    
    // í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
    function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        document.getElementById('currentTime').textContent = timeString;
    }
    
    // ì œì–´ ë²„íŠ¼ í•¨ìˆ˜ë“¤
    function startTrading() {
        document.getElementById('systemStatus').textContent = 'ì‹¤í–‰ì¤‘';
        document.getElementById('systemStatus').className = 'text-success';
        alert('ìë™ë§¤ë§¤ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.');
    }
    
    function stopTrading() {
        document.getElementById('systemStatus').textContent = 'ì¤‘ì§€ë¨';
        document.getElementById('systemStatus').className = 'text-danger';
        alert('ìë™ë§¤ë§¤ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤.');
    }
    
    function trainAI() {
        document.getElementById('aiStatus').textContent = 'í•™ìŠµì¤‘';
        document.getElementById('aiStatus').className = 'badge bg-info';
        alert('AI í•™ìŠµì„ ì‹œì‘í•©ë‹ˆë‹¤.');
        
        // 3ì´ˆ í›„ ì™„ë£Œë¡œ ë³€ê²½
        setTimeout(() => {
            document.getElementById('aiStatus').textContent = 'ì™„ë£Œ';
            document.getElementById('aiStatus').className = 'badge bg-success';
        }, 3000);
    }
    
    function emergencyStop() {
        if (confirm('ëª¨ë“  í¬ì§€ì…˜ì„ ì²­ì‚°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            alert('ê¸´ê¸‰ ì²­ì‚°ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.');
            // í¬ì§€ì…˜ ì´ˆê¸°í™”
            tradingData.longPosition.size = 0;
            tradingData.shortPosition.size = 0;
            updatePositionLines();
        }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸš€ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
        
        // Lightweight Charts ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸
        console.log('LightweightCharts ê°ì²´:', typeof LightweightCharts);
        if (LightweightCharts) {
            console.log('LightweightCharts ë²„ì „:', LightweightCharts.version || 'unknown');
            console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ë©”ì„œë“œë“¤:', Object.getOwnPropertyNames(LightweightCharts));
        }
        
        if (typeof LightweightCharts === 'undefined') {
            console.error('âŒ Lightweight Charts ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
            document.getElementById('trading-chart').innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #1e1e1e; color: white;">
                    <div style="text-align: center;">
                        <h5>âš ï¸ ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨</h5>
                        <p>Lightweight Chartsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                        <button onclick="location.reload()" class="btn btn-primary">ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>
            `;
            return;
        } else {
            console.log('âœ… Lightweight Charts ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ');
        }
        
        // ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘
        updateTime();
        setInterval(updateTime, 1000);
        
        // ì°¨íŠ¸ ì´ˆê¸°í™” (ë” ê¸´ ì§€ì—°ì‹œê°„)
        setTimeout(() => {
            console.log('ğŸ¯ ì°¨íŠ¸ ì´ˆê¸°í™” ì‹œì‘...');
            try {
                initChart();
                console.log('âœ… ì°¨íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ ì°¨íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                document.getElementById('trading-chart').innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #1e1e1e; color: white;">
                        <div style="text-align: center;">
                            <h5>âŒ ì°¨íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨</h5>
                            <p>${error.message}</p>
                            <button onclick="location.reload()" class="btn btn-primary">ìƒˆë¡œê³ ì¹¨</button>
                        </div>
                    </div>
                `;
            }
        }, 500);
        
        // í˜ì´ì§€ ë¡œë“œ ì• ë‹ˆë©”ì´ì…˜
        const cards = document.querySelectorAll('.status-card, .main-card');
        cards.forEach((card, index) => {
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
    });
</script>
{% endblock %}