<!-- web/templates/dashboard.html -->
{% extends "base.html" %}

{% block title %}대시보드 - 자동매매{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 페이지 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-4 page-header">
        <h2 class="mb-0">
            <i class="bi bi-speedometer2 me-2"></i>대시보드
        </h2>
        <div class="current-time">
            <i class="bi bi-clock me-1"></i>
            <span id="currentTime"></span>
        </div>
    </div>

    <!-- 상태 카드들 -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card status-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>시스템 상태</h6>
                            <h4 id="systemStatus" class="text-danger">중지됨</h4>
                        </div>
                        <div class="card-icon text-danger">
                            <i class="bi bi-power" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card status-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>총 잔고</h6>
                            <h4 id="totalBalance" class="text-primary">10,000,000원</h4>
                        </div>
                        <div class="card-icon text-primary">
                            <i class="bi bi-wallet2" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card status-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>오늘 수익</h6>
                            <h4 id="todayProfit" class="text-success">+150,000원</h4>
                        </div>
                        <div class="card-icon text-success">
                            <i class="bi bi-graph-up-arrow" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card status-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>수익률</h6>
                            <h4 id="profitRate" class="text-success">+1.5%</h4>
                        </div>
                        <div class="card-icon text-success">
                            <i class="bi bi-percent" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 좌측: 차트 + 제어판 -->
        <div class="col-lg-8 mb-4">
            <!-- 차트 영역 -->
            <div class="card main-card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>비트코인 차트
                    </h5>
                    <div class="chart-controls">
                        <select id="chartSymbol" class="form-select form-select-sm me-2" style="width: auto;" onchange="changeSymbol()">
                            <option value="BTCUSDT">BTC/USDT</option>
                            <option value="ETHUSDT">ETH/USDT</option>
                            <option value="ADAUSDT">ADA/USDT</option>
                            <option value="SOLUSDT">SOL/USDT</option>
                        </select>
                        <select id="chartInterval" class="form-select form-select-sm" style="width: auto;" onchange="changeInterval()">
                            <option value="1m">1분</option>
                            <option value="5m">5분</option>
                            <option value="15m" selected>15분</option>
                            <option value="1h">1시간</option>
                            <option value="4h">4시간</option>
                            <option value="1d">1일</option>
                        </select>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Lightweight Charts 컨테이너 -->
                    <div id="trading-chart" style="height: 600px; width: 100%;"></div>
                </div>
            </div>

            <!-- 제어 버튼들 -->
            <div class="card main-card">
                <div class="card-header">
                    <h5>
                        <i class="bi bi-gear me-2"></i>제어판
                    </h5>
                </div>
                <div class="card-body control-buttons">
                    <div class="row g-3">
                        <div class="col-6 col-md-3">
                            <button class="btn btn-success w-100" onclick="startTrading()">
                                <i class="bi bi-play-fill me-1"></i>시작
                            </button>
                        </div>
                        <div class="col-6 col-md-3">
                            <button class="btn btn-danger w-100" onclick="stopTrading()">
                                <i class="bi bi-stop-fill me-1"></i>중단
                            </button>
                        </div>
                        <div class="col-6 col-md-3">
                            <button class="btn btn-warning w-100" onclick="trainAI()">
                                <i class="bi bi-brain me-1"></i>AI 학습
                            </button>
                        </div>
                        <div class="col-6 col-md-3">
                            <button class="btn btn-outline-danger w-100" onclick="emergencyStop()">
                                <i class="bi bi-exclamation-triangle me-1"></i>긴급 청산
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 우측: 포지션 및 정보 -->
        <div class="col-lg-4">
            <!-- 포지션 현황 -->
            <div class="card main-card mb-4">
                <div class="card-header">
                    <h5>
                        <i class="bi bi-pie-chart me-2"></i>포지션 현황
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <div class="position-box long-position">
                                <h6 class="text-success mb-1">롱 포지션</h6>
                                <p id="longSize" class="mb-1">0.05 BTC</p>
                                <small id="longAvgPrice">@ 95,000,000원</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="position-box short-position">
                                <h6 class="text-danger mb-1">숏 포지션</h6>
                                <p id="shortSize" class="mb-1">0.05 BTC</p>
                                <small id="shortAvgPrice">@ 95,000,000원</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="total-pnl">
                        <h6>총 미실현 손익</h6>
                        <h4 id="totalPnl">+150,000원</h4>
                        <small id="totalPnlPercent">+1.5%</small>
                    </div>
                </div>
            </div>

            <!-- AI 상태 -->
            <div class="card main-card mb-4">
                <div class="card-header">
                    <h5>
                        <i class="bi bi-brain me-2"></i>AI 모델 상태
                    </h5>
                </div>
                <div class="card-body">
                    <div class="ai-status-item d-flex justify-content-between align-items-center">
                        <span>모델 상태</span>
                        <span id="aiStatus" class="badge bg-warning">대기중</span>
                    </div>
                    <div class="ai-status-item d-flex justify-content-between align-items-center">
                        <span>마지막 학습</span>
                        <span id="lastTraining" class="text-muted">2시간 전</span>
                    </div>
                    <div class="ai-status-item d-flex justify-content-between align-items-center">
                        <span>정확도</span>
                        <span id="aiAccuracy" class="text-success">85.3%</span>
                    </div>
                    <div class="ai-progress mt-2">
                        <div id="aiProgressBar" class="progress-bar" style="width: 85.3%"></div>
                    </div>
                </div>
            </div>

            <!-- 최근 거래 -->
            <div class="card main-card">
                <div class="card-header">
                    <h5>
                        <i class="bi bi-clock-history me-2"></i>최근 거래
                    </h5>
                </div>
                <div class="card-body" id="recentTrades">
                    <div class="recent-trade d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-success">매수</span>
                            <span class="ms-2">0.01 BTC</span>
                        </div>
                        <small>10분 전</small>
                    </div>
                    <div class="recent-trade d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-danger">매도</span>
                            <span class="ms-2">0.01 BTC</span>
                        </div>
                        <small>1시간 전</small>
                    </div>
                    <div class="recent-trade d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-success">매수</span>
                            <span class="ms-2">0.02 BTC</span>
                        </div>
                        <small>3시간 전</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Lightweight Charts 라이브러리 (안정적인 버전) -->
<script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>

<script>
    // 전역 변수들
    let chart = null;
    let candlestickSeries = null;
    let currentSymbol = 'BTCUSDT';
    let currentInterval = '15m';
    let markers = [];
    let longAvgLine = null;
    let shortAvgLine = null;
    
    // 자동매매 포지션 데이터 (실제 데이터로 수정)
    let tradingData = {
        longPosition: {
            size: 0.05,
            avgPrice: 100000000,  // 1억원 (실제 비트코인 가격 근처)
            pnl: 75000
        },
        shortPosition: {
            size: 0.05,
            avgPrice: 102000000,  // 1억2천만원
            pnl: 75000
        },
        trades: [
            // 고정된 매매 내역만 표시
        ]
    };
    
    // 차트 초기화
    function initChart() {
        console.log('🎯 initChart 함수 시작');
        
        const container = document.getElementById('trading-chart');
        if (!container) {
            console.error('❌ 차트 컨테이너를 찾을 수 없습니다!');
            return;
        }
        
        console.log('📦 컨테이너 크기:', container.clientWidth, 'x', container.clientHeight);
        
        try {
            // 차트 생성 (올바른 방법)
            console.log('차트 생성 시도...');
            chart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: 600,
                layout: {
                    backgroundColor: '#1e1e1e',
                    textColor: '#d1d4dc',
                },
                grid: {
                    vertLines: { 
                        color: '#2b2b43' 
                    },
                    horzLines: { 
                        color: '#2b2b43' 
                    },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                priceScale: {
                    borderColor: '#485c7b',
                },
                timeScale: {
                    borderColor: '#485c7b',
                    timeVisible: true,
                    secondsVisible: false,
                },
            });
            
            console.log('✅ 차트 객체 생성 완료');
            console.log('chart 객체:', chart);
            console.log('chart 메서드들:', Object.getOwnPropertyNames(chart));
            
            // 캔들스틱 시리즈 추가 (버전별 대응)
            try {
                candlestickSeries = chart.addCandlestickSeries({
                    upColor: '#26a69a',
                    downColor: '#ef5350',
                    borderVisible: false,
                    wickUpColor: '#26a69a',
                    wickDownColor: '#ef5350',
                });
                console.log('✅ 캔들스틱 시리즈 추가 완료 (addCandlestickSeries)');
            } catch (seriesError) {
                console.log('addCandlestickSeries 실패, 다른 방법 시도...');
                console.error('시리즈 에러:', seriesError);
                
                // 대안 방법 시도
                try {
                    candlestickSeries = chart.addSeries('Candlestick', {
                        upColor: '#26a69a',
                        downColor: '#ef5350',
                        borderVisible: false,
                        wickUpColor: '#26a69a',
                        wickDownColor: '#ef5350',
                    });
                    console.log('✅ 캔들스틱 시리즈 추가 완료 (addSeries)');
                } catch (altError) {
                    console.error('대안 방법도 실패:', altError);
                    throw altError;
                }
            }
            
            console.log('✅ 캔들스틱 시리즈 추가 완료');
            
            // 차트 데이터 로드
            loadChartData();
            
            // 포지션 평단가 라인 표시
            updatePositionLines();
            
            // 매매 마커 표시
            updateTradingMarkers();
            
            // 실시간 WebSocket 연결 시작
            setTimeout(() => {
                connectWebSocket();
            }, 2000);
            
            // 반응형 차트 크기 조정
            window.addEventListener('resize', handleResize);
            
            console.log('🎉 차트 초기화 완전 완료!');
            
        } catch (error) {
            console.error('❌ 차트 생성 중 오류:', error);
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #1e1e1e; color: white;">
                    <div style="text-align: center;">
                        <h5>❌ 차트 생성 실패</h5>
                        <p>${error.message}</p>
                        <button onclick="location.reload()" class="btn btn-primary">새로고침</button>
                    </div>
                </div>
            `;
        }
    }
    
    // 실제 비트코인 가격 데이터 가져오기
    async function loadChartData() {
        try {
            console.log('📊 실제 비트코인 데이터 로드 시작...');
            
            // Bybit API에서 실제 데이터 가져오기
            const symbol = currentSymbol;
            const interval = currentInterval;
            const response = await fetch(`https://api.bybit.com/v5/market/kline?category=spot&symbol=${symbol}&interval=${interval}&limit=200`);
            const data = await response.json();
            
            if (data.retCode === 0 && data.result && data.result.list) {
                const klineData = data.result.list.map(item => ({
                    time: parseInt(item[0]) / 1000, // timestamp를 초로 변환
                    open: parseFloat(item[1]),
                    high: parseFloat(item[2]), 
                    low: parseFloat(item[3]),
                    close: parseFloat(item[4])
                })).reverse(); // 시간순 정렬
                
                console.log('✅ 실제 데이터 로드 완료:', klineData.length, '개');
                console.log('📈 최신 가격:', klineData[klineData.length - 1]?.close);
                
                if (candlestickSeries && klineData.length > 0) {
                    candlestickSeries.setData(klineData);
                    console.log('✅ 차트 데이터 설정 완료');
                }
            } else {
                console.error('❌ API 응답 오류:', data);
                // 실패시 기본 데이터 사용
                const fallbackData = generateFallbackData();
                candlestickSeries.setData(fallbackData);
            }
            
        } catch (error) {
            console.error('❌ 실제 데이터 로드 실패:', error);
            // API 실패시 현실적인 샘플 데이터 사용
            const fallbackData = generateFallbackData();
            candlestickSeries.setData(fallbackData);
        }
    }
    
    // 현실적인 비트코인 가격 데이터 생성 (API 실패시 사용)
    function generateFallbackData() {
        const data = [];
        let basePrice = 101000000; // 현재 비트코인 가격 근처 (1억 1천만원)
        const now = new Date();
        
        for (let i = 200; i >= 0; i--) {
            const time = new Date(now.getTime() - i * getIntervalMs());
            
            // 현실적인 가격 변동 (±1% 내외)
            const variation = (Math.random() - 0.5) * basePrice * 0.02; // ±2% 변동
            const open = basePrice;
            const change = (Math.random() - 0.5) * basePrice * 0.015; // ±1.5% 변화
            const close = Math.max(open + change, basePrice * 0.95); // 최소 5% 하락 제한
            const high = Math.max(open, close) * (1 + Math.random() * 0.005); // 최대 0.5% 추가 상승
            const low = Math.min(open, close) * (1 - Math.random() * 0.005); // 최대 0.5% 추가 하락
            
            data.push({
                time: Math.floor(time.getTime() / 1000),
                open: Math.round(open),
                high: Math.round(high),
                low: Math.round(low),
                close: Math.round(close)
            });
            
            basePrice = close;
        }
        
        return data;
    }
    
    // 인터벌별 밀리초 변환
    function getIntervalMs() {
        const intervalMap = {
            '1m': 60 * 1000,
            '5m': 5 * 60 * 1000,
            '15m': 15 * 60 * 1000,
            '1h': 60 * 60 * 1000,
            '4h': 4 * 60 * 60 * 1000,
            '1d': 24 * 60 * 60 * 1000
        };
        return intervalMap[currentInterval] || 15 * 60 * 1000;
    }
    
    // 포지션 평단가 라인 업데이트
    function updatePositionLines() {
        console.log('🎯 포지션 평단가 라인 업데이트 중...');
        console.log('Long Position:', tradingData.longPosition);
        console.log('Short Position:', tradingData.shortPosition);
        
        // 기존 라인 제거
        if (longAvgLine) {
            candlestickSeries.removePriceLine(longAvgLine);
            console.log('기존 롱 라인 제거됨');
        }
        if (shortAvgLine) {
            candlestickSeries.removePriceLine(shortAvgLine);
            console.log('기존 숏 라인 제거됨');
        }
        
        // 롱 포지션 평단가 라인 (초록색)
        if (tradingData.longPosition.size > 0) {
            longAvgLine = candlestickSeries.createPriceLine({
                price: tradingData.longPosition.avgPrice,
                color: '#00ff00',
                lineWidth: 3,
                lineStyle: LightweightCharts.LineStyle.Solid,
                axisLabelVisible: true,
                title: `🟢 Long Avg: ${formatPrice(tradingData.longPosition.avgPrice)}원`
            });
            console.log('✅ 롱 평단가 라인 생성:', tradingData.longPosition.avgPrice);
        }
        
        // 숏 포지션 평단가 라인 (빨간색)
        if (tradingData.shortPosition.size > 0) {
            shortAvgLine = candlestickSeries.createPriceLine({
                price: tradingData.shortPosition.avgPrice,
                color: '#ff0000',
                lineWidth: 3,
                lineStyle: LightweightCharts.LineStyle.Solid,
                axisLabelVisible: true,
                title: `🔴 Short Avg: ${formatPrice(tradingData.shortPosition.avgPrice)}원`
            });
            console.log('✅ 숏 평단가 라인 생성:', tradingData.shortPosition.avgPrice);
        }
    }
    
    // 매매 마커 업데이트
    function updateTradingMarkers() {
        console.log('📌 매매 마커 업데이트 중...');
        console.log('총 거래 수:', tradingData.trades.length);
        
        markers = [];
        
        tradingData.trades.forEach((trade, index) => {
            const timestamp = new Date(trade.time).getTime() / 1000;
            
            const marker = {
                time: timestamp,
                position: trade.type === 'buy' ? 'belowBar' : 'aboveBar',
                color: trade.type === 'buy' ? '#00ff00' : '#ff0000',
                shape: trade.type === 'buy' ? 'arrowUp' : 'arrowDown',
                text: `${trade.type === 'buy' ? '🟢 매수' : '🔴 매도'} ${trade.amount} BTC\n${formatPrice(trade.price)}원`
            };
            
            markers.push(marker);
            console.log(`마커 ${index + 1}:`, marker.text);
        });
        
        console.log('✅ 총', markers.length, '개 마커 추가됨');
        candlestickSeries.setMarkers(markers);
    }
    
    // 가격 포맷팅
    function formatPrice(price) {
        return price.toLocaleString('ko-KR');
    }
    
    // 새로운 거래 추가
    function addNewTrade(type, price, amount) {
        const now = new Date();
        const newTrade = {
            time: now.toISOString().slice(0, 19).replace('T', ' '),
            type: type,
            price: price,
            amount: amount
        };
        
        tradingData.trades.push(newTrade);
        updateTradingMarkers();
        updateRecentTrades();
    }
    
    // 최근 거래 목록 업데이트
    function updateRecentTrades() {
        const container = document.getElementById('recentTrades');
        container.innerHTML = '';
        
        const recentTrades = tradingData.trades.slice(-5).reverse();
        
        recentTrades.forEach(trade => {
            const timeAgo = getTimeAgo(new Date(trade.time));
            const div = document.createElement('div');
            div.className = 'recent-trade d-flex justify-content-between align-items-center';
            div.innerHTML = `
                <div>
                    <span class="badge ${trade.type === 'buy' ? 'bg-success' : 'bg-danger'}">${trade.type === 'buy' ? '매수' : '매도'}</span>
                    <span class="ms-2">${trade.amount} BTC</span>
                </div>
                <small>${timeAgo}</small>
            `;
            container.appendChild(div);
        });
    }
    
    // 시간 차이 계산
    function getTimeAgo(date) {
        const now = new Date();
        const diff = Math.floor((now - date) / 1000 / 60);
        
        if (diff < 1) return '방금 전';
        if (diff < 60) return `${diff}분 전`;
        if (diff < 1440) return `${Math.floor(diff / 60)}시간 전`;
        return `${Math.floor(diff / 1440)}일 전`;
    }
    
    // 심볼 변경
    function changeSymbol() {
        const symbol = document.getElementById('chartSymbol').value;
        currentSymbol = symbol;
        console.log('심볼 변경:', symbol);
        
        // WebSocket 재연결
        disconnectWebSocket();
        loadChartData();
        setTimeout(() => {
            connectWebSocket();
        }, 1000);
    }
    
    // 시간대 변경
    function changeInterval() {
        const interval = document.getElementById('chartInterval').value;
        currentInterval = interval;
        console.log('인터벌 변경:', interval);
        
        // WebSocket 재연결
        disconnectWebSocket();
        loadChartData();
        setTimeout(() => {
            connectWebSocket();
        }, 1000);
    }
    
    // 반응형 차트 크기 조정
    function handleResize() {
        const container = document.getElementById('trading-chart');
        if (chart) {
            chart.applyOptions({ width: container.clientWidth });
        }
    }
    
    // WebSocket 연결 변수
    let websocket = null;
    let isConnected = false;
    
    // 실시간 비트코인 가격 WebSocket 연결
    function connectWebSocket() {
        try {
            console.log('🔌 실시간 WebSocket 연결 중...');
            
            // Bybit WebSocket 연결
            websocket = new WebSocket('wss://stream.bybit.com/v5/public/spot');
            
            websocket.onopen = function() {
                console.log('✅ WebSocket 연결 성공');
                isConnected = true;
                
                // 실시간 캔들스틱 데이터 구독
                const subscribeMsg = {
                    op: "subscribe",
                    args: [`kline.${currentInterval}.${currentSymbol}`]
                };
                websocket.send(JSON.stringify(subscribeMsg));
                console.log('📊 실시간 캔들 데이터 구독:', `kline.${currentInterval}.${currentSymbol}`);
            };
            
            websocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    
                    // 캔들스틱 데이터 업데이트
                    if (data.topic && data.topic.includes('kline') && data.data) {
                        const klineData = data.data[0];
                        const candleUpdate = {
                            time: parseInt(klineData.start) / 1000,
                            open: parseFloat(klineData.open),
                            high: parseFloat(klineData.high),
                            low: parseFloat(klineData.low),
                            close: parseFloat(klineData.close)
                        };
                        
                        // 실시간 캔들 업데이트
                        if (candlestickSeries) {
                            candlestickSeries.update(candleUpdate);
                            console.log('📈 실시간 업데이트:', candleUpdate.close);
                        }
                    }
                } catch (error) {
                    console.error('❌ WebSocket 메시지 파싱 오류:', error);
                }
            };
            
            websocket.onclose = function() {
                console.log('🔌 WebSocket 연결 종료');
                isConnected = false;
                
                // 5초 후 재연결 시도
                setTimeout(() => {
                    if (!isConnected) {
                        console.log('🔄 WebSocket 재연결 시도...');
                        connectWebSocket();
                    }
                }, 5000);
            };
            
            websocket.onerror = function(error) {
                console.error('❌ WebSocket 오류:', error);
                isConnected = false;
            };
            
        } catch (error) {
            console.error('❌ WebSocket 연결 실패:', error);
        }
    }
    
    // WebSocket 연결 해제
    function disconnectWebSocket() {
        if (websocket && isConnected) {
            websocket.close();
            console.log('🔌 WebSocket 연결 해제');
        }
    }
    
    // 현재 시간 업데이트
    function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        document.getElementById('currentTime').textContent = timeString;
    }
    
    // 제어 버튼 함수들
    function startTrading() {
        document.getElementById('systemStatus').textContent = '실행중';
        document.getElementById('systemStatus').className = 'text-success';
        alert('자동매매를 시작합니다.');
    }
    
    function stopTrading() {
        document.getElementById('systemStatus').textContent = '중지됨';
        document.getElementById('systemStatus').className = 'text-danger';
        alert('자동매매를 중단합니다.');
    }
    
    function trainAI() {
        document.getElementById('aiStatus').textContent = '학습중';
        document.getElementById('aiStatus').className = 'badge bg-info';
        alert('AI 학습을 시작합니다.');
        
        // 3초 후 완료로 변경
        setTimeout(() => {
            document.getElementById('aiStatus').textContent = '완료';
            document.getElementById('aiStatus').className = 'badge bg-success';
        }, 3000);
    }
    
    function emergencyStop() {
        if (confirm('모든 포지션을 청산하시겠습니까?')) {
            alert('긴급 청산을 실행합니다.');
            // 포지션 초기화
            tradingData.longPosition.size = 0;
            tradingData.shortPosition.size = 0;
            updatePositionLines();
        }
    }
    
    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 페이지 로드 완료');
        
        // Lightweight Charts 라이브러리 로드 확인
        console.log('LightweightCharts 객체:', typeof LightweightCharts);
        if (LightweightCharts) {
            console.log('LightweightCharts 버전:', LightweightCharts.version || 'unknown');
            console.log('사용 가능한 메서드들:', Object.getOwnPropertyNames(LightweightCharts));
        }
        
        if (typeof LightweightCharts === 'undefined') {
            console.error('❌ Lightweight Charts 라이브러리가 로드되지 않았습니다!');
            document.getElementById('trading-chart').innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #1e1e1e; color: white;">
                    <div style="text-align: center;">
                        <h5>⚠️ 차트 라이브러리 로드 실패</h5>
                        <p>Lightweight Charts가 로드되지 않았습니다.</p>
                        <button onclick="location.reload()" class="btn btn-primary">새로고침</button>
                    </div>
                </div>
            `;
            return;
        } else {
            console.log('✅ Lightweight Charts 라이브러리 로드 완료');
        }
        
        // 시간 업데이트 시작
        updateTime();
        setInterval(updateTime, 1000);
        
        // 차트 초기화 (더 긴 지연시간)
        setTimeout(() => {
            console.log('🎯 차트 초기화 시작...');
            try {
                initChart();
                console.log('✅ 차트 초기화 완료');
            } catch (error) {
                console.error('❌ 차트 초기화 실패:', error);
                document.getElementById('trading-chart').innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #1e1e1e; color: white;">
                        <div style="text-align: center;">
                            <h5>❌ 차트 초기화 실패</h5>
                            <p>${error.message}</p>
                            <button onclick="location.reload()" class="btn btn-primary">새로고침</button>
                        </div>
                    </div>
                `;
            }
        }, 500);
        
        // 페이지 로드 애니메이션
        const cards = document.querySelectorAll('.status-card, .main-card');
        cards.forEach((card, index) => {
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
        
        // 페이지 떠날 때 WebSocket 연결 해제
        window.addEventListener('beforeunload', () => {
            disconnectWebSocket();
        });
    });
</script>
{% endblock %}