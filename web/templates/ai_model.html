<!-- 파일 경로: web/templates/ai_model.html -->
<!-- 코드명: AI 모델 관리 페이지 템플릿 (필수/선택 지표 구분 UI) -->

{% extends "base.html" %}

{% block title %}NHBot - AI 모델 관리{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ai_model.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 페이지 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-4 page-header">
        <h2 class="mb-0">
            <i class="bi bi-cpu me-2"></i>AI 모델 관리
        </h2>
        <div class="current-time">
            <i class="bi bi-clock me-1"></i>
            <span id="currentTime"></span>
        </div>
    </div>

    <div class="row">
        <!-- 좌측: 학습 설정 및 실행 -->
        <div class="col-lg-8 mb-4">
            <!-- 학습 지표 선택 (개선된 UI) -->
            <div class="card main-card mb-4">
                <div class="card-header">
                    <h5>
                        <i class="bi bi-graph-up me-2"></i>학습 지표 선택
                        <span class="badge bg-info ms-2" id="selectedIndicatorCount">10/17개 선택</span>
                    </h5>
                </div>
                <div class="card-body">
                    <!-- 필수 지표 섹션 -->
                    <div class="indicator-section mb-4">
                        <h6 class="section-title">
                            <i class="bi bi-star-fill text-warning me-2"></i>필수 지표
                            <small class="text-muted ms-2">(항상 포함됨)</small>
                        </h6>
                        <div class="essential-indicators-grid">
                            <div class="indicator-card essential">
                                <div class="indicator-header">
                                    <input type="checkbox" checked class="form-check-input indicator-checkbox" id="indicator_price" data-indicator="price">
                                    <label class="indicator-name">가격 데이터</label>
                                    <span class="indicator-badge">3</span>
                                </div>
                                <small class="indicator-desc">종가, 변화율, 고저범위</small>
                            </div>
                            <div class="indicator-card essential">
                                <div class="indicator-header">
                                    <input type="checkbox" checked disabled class="form-check-input">
                                    <label class="indicator-name">MACD</label>
                                    <span class="indicator-badge">3</span>
                                </div>
                                <small class="indicator-desc">MACD, 시그널, 히스토그램</small>
                            </div>
                            <div class="indicator-card essential">
                                <div class="indicator-header">
                                    <input type="checkbox" checked disabled class="form-check-input">
                                    <label class="indicator-name">RSI</label>
                                    <span class="indicator-badge">1</span>
                                </div>
                                <small class="indicator-desc">14일 RSI</small>
                            </div>
                            <div class="indicator-card essential">
                                <div class="indicator-header">
                                    <input type="checkbox" checked disabled class="form-check-input">
                                    <label class="indicator-name">볼린저밴드</label>
                                    <span class="indicator-badge">2</span>
                                </div>
                                <small class="indicator-desc">위치, 폭</small>
                            </div>
                            <div class="indicator-card essential">
                                <div class="indicator-header">
                                    <input type="checkbox" checked disabled class="form-check-input">
                                    <label class="indicator-name">ATR</label>
                                    <span class="indicator-badge">1</span>
                                </div>
                                <small class="indicator-desc">평균 실제 범위</small>
                            </div>
                            <div class="indicator-card essential">
                                <div class="indicator-header">
                                    <input type="checkbox" checked disabled class="form-check-input">
                                    <label class="indicator-name">거래량</label>
                                    <span class="indicator-badge">3</span>
                                </div>
                                <small class="indicator-desc">비율, CVD, CVD 기울기</small>
                            </div>
                            <div class="indicator-card essential">
                                <div class="indicator-header">
                                    <input type="checkbox" checked disabled class="form-check-input">
                                    <label class="indicator-name">ADX</label>
                                    <span class="indicator-badge">2</span>
                                </div>
                                <small class="indicator-desc">추세강도, 기울기</small>
                            </div>
                            <div class="indicator-card essential">
                                <div class="indicator-header">
                                    <input type="checkbox" checked disabled class="form-check-input">
                                    <label class="indicator-name">Aroon</label>
                                    <span class="indicator-badge">1</span>
                                </div>
                                <small class="indicator-desc">추세 전환 타이밍</small>
                            </div>
                            <div class="indicator-card essential">
                                <div class="indicator-header">
                                    <input type="checkbox" checked disabled class="form-check-input">
                                    <label class="indicator-name">연속 카운터</label>
                                    <span class="indicator-badge">2</span>
                                </div>
                                <small class="indicator-desc">연속 상승/하락</small>
                            </div>
                            <div class="indicator-card essential">
                                <div class="indicator-header">
                                    <input type="checkbox" checked disabled class="form-check-input">
                                    <label class="indicator-name">다중 시간대</label>
                                    <span class="indicator-badge">4</span>
                                </div>
                                <small class="indicator-desc">1H, 4H 추세, 정렬도</small>
                            </div>
                        </div>
                    </div>

                    <!-- 선택적 지표 섹션 -->
                    <div class="indicator-section">
                        <h6 class="section-title">
                            <i class="bi bi-plus-circle me-2"></i>선택적 지표
                            <small class="text-muted ms-2">(필요시 추가)</small>
                        </h6>
                        <div class="optional-indicators-grid">
                            <div class="indicator-card optional">
                                <div class="indicator-header">
                                    <input type="checkbox" id="indicator_sma" class="form-check-input indicator-checkbox" data-indicator="sma">
                                    <label class="indicator-name" for="indicator_sma">SMA</label>
                                    <span class="indicator-badge">2</span>
                                </div>
                                <small class="indicator-desc">단순이동평균</small>
                            </div>
                            <div class="indicator-card optional">
                                <div class="indicator-header">
                                    <input type="checkbox" id="indicator_ema" class="form-check-input indicator-checkbox" data-indicator="ema">
                                    <label class="indicator-name" for="indicator_ema">EMA</label>
                                    <span class="indicator-badge">3</span>
                                </div>
                                <small class="indicator-desc">지수이동평균</small>
                            </div>
                            <div class="indicator-card optional">
                                <div class="indicator-header">
                                    <input type="checkbox" id="indicator_stoch" class="form-check-input indicator-checkbox" data-indicator="stoch">
                                    <label class="indicator-name" for="indicator_stoch">스토캐스틱</label>
                                    <span class="indicator-badge">2</span>
                                </div>
                                <small class="indicator-desc">K%, D%</small>
                            </div>
                            <div class="indicator-card optional">
                                <div class="indicator-header">
                                    <input type="checkbox" id="indicator_williams" class="form-check-input indicator-checkbox" data-indicator="williams">
                                    <label class="indicator-name" for="indicator_williams">Williams %R</label>
                                    <span class="indicator-badge">1</span>
                                </div>
                                <small class="indicator-desc">모멘텀 지표</small>
                            </div>
                            <div class="indicator-card optional">
                                <div class="indicator-header">
                                    <input type="checkbox" id="indicator_mfi" class="form-check-input indicator-checkbox" data-indicator="mfi">
                                    <label class="indicator-name" for="indicator_mfi">MFI</label>
                                    <span class="indicator-badge">1</span>
                                </div>
                                <small class="indicator-desc">자금흐름지표</small>
                            </div>
                            <div class="indicator-card optional">
                                <div class="indicator-header">
                                    <input type="checkbox" id="indicator_vwap" class="form-check-input indicator-checkbox" data-indicator="vwap">
                                    <label class="indicator-name" for="indicator_vwap">VWAP</label>
                                    <span class="indicator-badge">1</span>
                                </div>
                                <small class="indicator-desc">거래량가중평균</small>
                            </div>
                            <div class="indicator-card optional">
                                <div class="indicator-header">
                                    <input type="checkbox" id="indicator_volatility" class="form-check-input indicator-checkbox" data-indicator="volatility">
                                    <label class="indicator-name" for="indicator_volatility">변동성</label>
                                    <span class="indicator-badge">1</span>
                                </div>
                                <small class="indicator-desc">20일 변동성</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 학습 파라미터 설정 -->
            <div class="card main-card mb-4">
                <div class="card-header">
                    <h5>
                        <i class="bi bi-sliders me-2"></i>학습 파라미터 설정
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-medium">학습 데이터 기간</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="trainingDays" value="365" min="30" max="1095">
                                <span class="input-group-text">일</span>
                            </div>
                            <div class="form-text">과거 몇 일간의 데이터로 학습할지 설정</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-medium">에폭 (Epochs)</label>
                            <input type="number" class="form-control" id="epochs" value="100" min="10" max="1000">
                            <div class="form-text">모델 학습 반복 횟수</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-medium">배치 크기 (Batch Size)</label>
                            <input type="number" class="form-control" id="batchSize" value="32" min="8" max="128">
                            <div class="form-text">한 번에 처리할 데이터 개수</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-medium">학습률 (Learning Rate)</label>
                            <input type="number" class="form-control" id="learningRate" value="0.001" min="0.0001" max="0.1" step="0.0001">
                            <div class="form-text">모델 가중치 업데이트 속도</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-medium">시퀀스 길이</label>
                            <input type="number" class="form-control" id="sequenceLength" value="60" min="10" max="200">
                            <div class="form-text">예측에 사용할 과거 데이터 개수 (분)</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-medium">검증 비율</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="validationSplit" value="20" min="10" max="30">
                                <span class="input-group-text">%</span>
                            </div>
                            <div class="form-text">검증용으로 사용할 데이터 비율</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 학습 실행 및 모니터링 -->
            <div class="card main-card">
                <div class="card-header">
                    <h5>
                        <i class="bi bi-play-circle me-2"></i>학습 실행 및 모니터링
                    </h5>
                </div>
                <div class="card-body">
                    <!-- 학습 제어 버튼 -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="d-flex gap-2">
                                <button class="btn btn-success" id="startTrainingBtn">
                                    <i class="bi bi-play-fill me-1"></i>학습 시작
                                </button>
                                <button class="btn btn-danger" id="stopTrainingBtn" disabled>
                                    <i class="bi bi-stop-fill me-1"></i>학습 중지
                                </button>
                                <button class="btn btn-outline-secondary" id="resetParametersBtn">
                                    <i class="bi bi-arrow-clockwise me-1"></i>기본값 복원
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="training-status">
                                <span class="badge bg-secondary" id="trainingStatus">대기 중</span>
                            </div>
                        </div>
                    </div>

                    <!-- 학습 진행률 -->
                    <div id="trainingProgress" style="display: none;">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">전체 진행률</label>
                                <div class="progress mb-2" style="height: 25px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         id="overallProgress" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted" id="progressText">0/100 에폭</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">현재 에폭 진행률</label>
                                <div class="progress mb-2" style="height: 25px;">
                                    <div class="progress-bar bg-info progress-bar-striped progress-bar-animated" 
                                         id="epochProgress" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted" id="epochText">0/100 배치</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="training-info">
                                    <div class="info-item">
                                        <span class="label">시작 시간:</span>
                                        <span id="startTime">-</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">경과 시간:</span>
                                        <span id="elapsedTime">00:00:00</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">예상 완료:</span>
                                        <span id="estimatedTime">-</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="training-metrics">
                                    <div class="metric-item">
                                        <span class="label">Loss:</span>
                                        <span id="currentLoss" class="value">-</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="label">Accuracy:</span>
                                        <span id="currentAccuracy" class="value">-</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="label">Val Loss:</span>
                                        <span id="valLoss" class="value">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 우측: 모델 히스토리 및 관리 -->
        <div class="col-lg-4">
            <!-- 현재 활성 모델 -->
            <div class="card main-card mb-4">
                <div class="card-header">
                    <h5>
                        <i class="bi bi-star me-2"></i>현재 활성 모델
                    </h5>
                </div>
                <div class="card-body">
                    <div class="active-model-info">
                        <div class="model-name">
                            <strong id="activeModelName">모델 없음</strong>
                        </div>
                        <div class="model-stats">
                            <div class="stat-item">
                                <span class="label">정확도:</span>
                                <span class="value text-success" id="activeModelAccuracy">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="label">학습일:</span>
                                <span class="value" id="activeModelDate">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="label">상태:</span>
                                <span id="activeModelBadge" class="badge bg-secondary">비활성</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 모델 히스토리 -->
            <div class="card main-card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>모델 히스토리
                    </h5>
                    <button class="btn btn-outline-danger btn-sm" id="cleanupModelsBtn">
                        <i class="bi bi-trash me-1"></i>정리
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="model-list">
                        <!-- JavaScript로 동적 생성 -->
                    </div>
                </div>
            </div>

            <!-- 자동 학습 스케줄러 -->
            <div class="card main-card">
                <div class="card-header">
                    <h5>
                        <i class="bi bi-calendar-event me-2"></i>자동 학습 스케줄러
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="autoRetraining" checked>
                        <label class="form-check-label fw-medium" for="autoRetraining">
                            자동 재학습 활성화
                        </label>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-medium">재학습 간격</label>
                        <select class="form-select" id="retrainingInterval">
                            <option value="86400">매일 (24시간)</option>
                            <option value="172800">2일마다</option>
                            <option value="604800">매주 (7일)</option>
                            <option value="1209600">2주마다</option>
                        </select>
                    </div>
                    
                    <div class="next-training">
                        <small class="text-muted">다음 자동 학습: </small>
                        <small id="nextTraining">-</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 토스트 컨테이너 -->
<div id="toastContainer"></div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/ai_model.js') }}"></script>
{% endblock %}